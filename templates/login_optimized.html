<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Namaskah SMS</title>
    <link rel="stylesheet" href="/static/css/auth.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>ðŸ“± Namaskah SMS</h1>
                <p>Smart SMS Verification Platform</p>
            </div>

            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>

                <button type="submit" class="btn-primary" id="login-btn">
                    Sign In
                </button>
            </form>

            <div class="divider">
                <span>or</span>
            </div>

            <div id="google-signin-container">
                <div id="g_id_onload"
                     data-client_id=""
                     data-callback="handleGoogleSignIn"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>
            </div>

            <div class="auth-links">
                <a href="/auth/forgot-password">Forgot Password?</a>
                <span>â€¢</span>
                <a href="/register">Create Account</a>
            </div>

            <div class="features-preview">
                <h3>ðŸš€ Enhanced Features</h3>
                <ul>
                    <li>âœ… Smart verification routing</li>
                    <li>ðŸ’° Dynamic pricing optimization</li>
                    <li>ðŸ“Š Real-time analytics</li>
                    <li>âš¡ Bulk operations</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        class AuthManager {
            constructor() {
                this.setupEventListeners();
                this.loadGoogleConfig();
            }

            async loadGoogleConfig() {
                try {
                    const response = await fetch('/auth/google/config');
                    const config = await response.json();
                    
                    if (config.enabled && config.client_id) {
                        document.querySelector('[data-client_id]').setAttribute('data-client_id', config.client_id);
                        console.log('Google OAuth configured');
                    } else {
                        document.getElementById('google-signin-container').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Failed to load Google config:', error);
                    document.getElementById('google-signin-container').style.display = 'none';
                }
            }

            setupEventListeners() {
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
            }

            async handleLogin() {
                const form = document.getElementById('login-form');
                const loginBtn = document.getElementById('login-btn');
                
                // Minimal form validation
                if (!validateForm(form)) {
                    return;
                }
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                setButtonState(loginBtn, 'loading', 'Signing in...');

                try {
                    const response = await fetch('/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user_id', data.user_id);
                        
                        if (data.is_admin) {
                            window.location.href = '/admin';
                        } else {
                            window.location.href = '/dashboard';
                        }
                    } else {
                        this.showError(data.detail || 'Login failed');
                    }
                } catch (error) {
                    this.showError('Network error. Please try again.');
                } finally {
                    setButtonState(loginBtn, 'default', 'Sign In');
                }
            }

            showError(message) {
                const existingError = document.querySelector('.error-message');
                if (existingError) existingError.remove();

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                
                document.querySelector('.auth-form').appendChild(errorDiv);
                
                setTimeout(() => errorDiv.remove(), 5000);
            }
        }

        // Google Sign-In callback
        async function handleGoogleSignIn(response) {
            try {
                const result = await fetch('/auth/google', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: response.credential })
                });

                const data = await result.json();

                if (result.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user_id', data.user_id);
                    
                    if (data.is_admin) {
                        window.location.href = '/admin';
                    } else {
                        window.location.href = '/dashboard';
                    }
                } else {
                    auth.showError(data.detail || 'Google sign-in failed');
                }
            } catch (error) {
                auth.showError('Google sign-in error. Please try again.');
            }
        }

        // Initialize
        const auth = new AuthManager();

        // Check if already logged in
        if (localStorage.getItem('token')) {
            window.location.href = '/dashboard';
        }
    </script>
    <script src="/static/js/minimal-error-handling.js"></script>
</body>
</html>