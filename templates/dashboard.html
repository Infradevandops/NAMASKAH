<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Namaskah SMS - Simple Verification</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a1628;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 600px; margin: 0 auto; }
        
        .card {
            background: #1a2942;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        
        h1 { text-align: center; margin-bottom: 30px; color: #d4af37; }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f1f3a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .service-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .service-btn:hover { background: #5a67d8; transform: translateY(-2px); }
        
        .verification-card {
            background: #10b981;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
        }
        
        .phone-display {
            font-family: monospace;
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
        }
        
        .messages {
            background: #f0fdf4;
            color: #166534;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .code {
            font-family: monospace;
            font-size: 20px;
            font-weight: bold;
            background: white;
            color: #166534;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            margin: 10px 0;
        }
        
        .btn {
            background: #d4af37;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .btn:hover { background: #b8941f; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        
        .hidden { display: none !important; }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            display: none;
        }
        
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #334155;
            background: #0f1f3a;
            color: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .auth-form { max-width: 400px; margin: 0 auto; }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .services-grid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); }
            .user-info { flex-direction: column; gap: 10px; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Namaskah SMS</h1>
        
        <!-- Auth Section -->
        <div id="auth-section">
            <div class="card auth-form">
                <h2>Login</h2>
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button class="btn" onclick="login()" style="width: 100%;">Login</button>
                <p style="text-align: center; margin: 10px 0;">or</p>
                <button class="btn" onclick="showRegister()" style="width: 100%; background: #667eea;">Register</button>
            </div>
        </div>
        
        <!-- App Section -->
        <div id="app-section" class="hidden">
            <div class="user-info">
                <div>
                    <div id="user-email"></div>
                    <div>Balance: N<span id="user-credits">0.00</span></div>
                </div>
                <div>
                    <button class="btn" onclick="showFundWallet()">Fund Wallet</button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>
            
            <div class="card">
                <h3>Create Verification</h3>
                
                <!-- Service Selection -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Select Service:</label>
                    <select id="service-select" style="width: 100%; padding: 12px; border: 2px solid #334155; background: #0f1f3a; color: white; border-radius: 8px; margin-bottom: 15px;">
                        <optgroup label="🔥 Most Popular (1,800+ Available)">
                            <option value="telegram">📱 Telegram - $0.75</option>
                            <option value="whatsapp">💬 WhatsApp - $0.75</option>
                            <option value="discord">🎮 Discord - $0.75</option>
                            <option value="google">🔍 Google - $0.75</option>
                            <option value="instagram">📷 Instagram - $1.00</option>
                            <option value="facebook">👥 Facebook - $1.00</option>
                            <option value="twitter">🐦 Twitter - $1.00</option>
                            <option value="tiktok">🎵 TikTok - $1.00</option>
                        </optgroup>
                        <optgroup label="💼 Business & Finance">
                            <option value="paypal">💳 PayPal - $1.50</option>
                            <option value="microsoft">🏢 Microsoft - $1.00</option>
                            <option value="amazon">📦 Amazon - $1.00</option>
                            <option value="apple">🍎 Apple - $1.25</option>
                            <option value="netflix">🎬 Netflix - $1.00</option>
                            <option value="spotify">🎵 Spotify - $0.85</option>
                        </optgroup>
                        <optgroup label="🎮 Gaming & Entertainment">
                            <option value="steam">🎮 Steam - $0.90</option>
                            <option value="twitch">📺 Twitch - $0.85</option>
                            <option value="youtube">📹 YouTube - $0.75</option>
                            <option value="reddit">🤖 Reddit - $0.80</option>
                            <option value="snapchat">👻 Snapchat - $1.00</option>
                            <option value="pinterest">📌 Pinterest - $0.85</option>
                        </optgroup>
                        <optgroup label="🛒 E-commerce & Services">
                            <option value="uber">🚗 Uber - $0.90</option>
                            <option value="lyft">🚕 Lyft - $0.90</option>
                            <option value="airbnb">🏠 Airbnb - $1.10</option>
                            <option value="ebay">🛒 eBay - $0.95</option>
                            <option value="etsy">🎨 Etsy - $0.85</option>
                            <option value="shopify">🛍️ Shopify - $1.00</option>
                        </optgroup>
                        <optgroup label="💰 Crypto & Trading">
                            <option value="coinbase">₿ Coinbase - $1.50</option>
                            <option value="binance">₿ Binance - $1.50</option>
                            <option value="kraken">₿ Kraken - $1.40</option>
                            <option value="robinhood">📈 Robinhood - $1.25</option>
                        </optgroup>
                        <optgroup label="📧 Communication">
                            <option value="outlook">📧 Outlook - $0.85</option>
                            <option value="yahoo">📧 Yahoo - $0.80</option>
                            <option value="protonmail">🔒 ProtonMail - $1.20</option>
                            <option value="slack">💬 Slack - $1.00</option>
                            <option value="zoom">📹 Zoom - $0.95</option>
                        </optgroup>
                    </select>
                </div>
                
                <!-- Verification Type Selection -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600;">Verification Type:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <label class="capability-option" style="display: flex; align-items: center; padding: 15px; border: 2px solid #334155; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: #1a2942;">
                            <input type="radio" name="capability" value="sms" checked style="margin-right: 12px; transform: scale(1.2);">
                            <div>
                                <div style="font-size: 18px; margin-bottom: 4px;">📱 SMS Text</div>
                                <div style="font-size: 12px; color: #94a3b8;">Receive code via text message</div>
                                <div style="font-size: 11px; color: #10b981; font-weight: 600;">Base Price</div>
                            </div>
                        </label>
                        <label class="capability-option" style="display: flex; align-items: center; padding: 15px; border: 2px solid #334155; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: #1a2942;">
                            <input type="radio" name="capability" value="voice" style="margin-right: 12px; transform: scale(1.2);">
                            <div>
                                <div style="font-size: 18px; margin-bottom: 4px;">📞 Voice Call</div>
                                <div style="font-size: 12px; color: #94a3b8;">Receive code via phone call</div>
                                <div style="font-size: 11px; color: #f59e0b; font-weight: 600;">+$0.30 Premium</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Country Selection -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Country (70 Available):</label>
                    <select id="country-select" style="width: 100%; padding: 12px; border: 2px solid #334155; background: #0f1f3a; color: white; border-radius: 8px;">
                        <optgroup label="🌟 Popular (Premium)">
                            <option value="US">🇺🇸 United States (1.0x)</option>
                            <option value="GB">🇬🇧 United Kingdom (1.2x)</option>
                            <option value="DE">🇩🇪 Germany (1.3x)</option>
                            <option value="CA">🇨🇦 Canada (1.1x)</option>
                            <option value="AU">🇦🇺 Australia (1.4x)</option>
                            <option value="FR">🇫🇷 France (1.3x)</option>
                            <option value="NL">🇳🇱 Netherlands (1.2x)</option>
                            <option value="CH">🇨🇭 Switzerland (1.8x)</option>
                            <option value="JP">🇯🇵 Japan (1.5x)</option>
                            <option value="SG">🇸🇬 Singapore (1.3x)</option>
                        </optgroup>
                        <optgroup label="🌍 Europe">
                            <option value="SE">🇸🇪 Sweden (1.5x)</option>
                            <option value="NO">🇳🇴 Norway (1.6x)</option>
                            <option value="DK">🇩🇰 Denmark (1.5x)</option>
                            <option value="FI">🇫🇮 Finland (1.4x)</option>
                            <option value="AT">🇦🇹 Austria (1.3x)</option>
                            <option value="BE">🇧🇪 Belgium (1.2x)</option>
                            <option value="IT">🇮🇹 Italy (1.1x)</option>
                            <option value="ES">🇪🇸 Spain (1.0x)</option>
                            <option value="PT">🇵🇹 Portugal (0.9x)</option>
                            <option value="IE">🇮🇪 Ireland (1.3x)</option>
                            <option value="PL">🇵🇱 Poland (0.8x)</option>
                            <option value="CZ">🇨🇿 Czech Republic (0.7x)</option>
                            <option value="HU">🇭🇺 Hungary (0.7x)</option>
                            <option value="RO">🇷🇴 Romania (0.6x)</option>
                        </optgroup>
                        <optgroup label="🌏 Asia-Pacific">
                            <option value="KR">🇰🇷 South Korea (1.2x)</option>
                            <option value="HK">🇭🇰 Hong Kong (1.1x)</option>
                            <option value="TW">🇹🇼 Taiwan (1.0x)</option>
                            <option value="MY">🇲🇾 Malaysia (0.6x)</option>
                            <option value="TH">🇹🇭 Thailand (0.5x)</option>
                            <option value="PH">🇵🇭 Philippines (0.4x)</option>
                            <option value="ID">🇮🇩 Indonesia (0.3x)</option>
                            <option value="VN">🇻🇳 Vietnam (0.3x)</option>
                            <option value="IN">🇮🇳 India (0.2x)</option>
                            <option value="CN">🇨🇳 China (0.8x)</option>
                        </optgroup>
                        <optgroup label="🌎 Americas">
                            <option value="MX">🇲🇽 Mexico (0.4x)</option>
                            <option value="BR">🇧🇷 Brazil (0.4x)</option>
                            <option value="AR">🇦🇷 Argentina (0.3x)</option>
                            <option value="CL">🇨🇱 Chile (0.5x)</option>
                            <option value="CO">🇨🇴 Colombia (0.3x)</option>
                            <option value="PE">🇵🇪 Peru (0.3x)</option>
                        </optgroup>
                        <optgroup label="🌍 Middle East & Africa">
                            <option value="AE">🇦🇪 UAE (0.8x)</option>
                            <option value="SA">🇸🇦 Saudi Arabia (0.6x)</option>
                            <option value="IL">🇮🇱 Israel (1.0x)</option>
                            <option value="TR">🇹🇷 Turkey (0.3x)</option>
                            <option value="ZA">🇿🇦 South Africa (0.4x)</option>
                            <option value="NG">🇳🇬 Nigeria (0.2x)</option>
                            <option value="EG">🇪🇬 Egypt (0.2x)</option>
                            <option value="RU">🇷🇺 Russia (0.3x)</option>
                        </optgroup>
                    </select>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">
                        📊 Price multiplier shown • 70 countries • 1,800+ services available
                    </div>
                    <div style="margin-top: 8px;">
                        <button type="button" onclick="loadAllServices()" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                            🔍 Browse All 1,800+ Services
                        </button>
                    </div>
                </div>
                
                <!-- Create Button -->
                <button class="btn" onclick="createVerification()" style="width: 100%; background: #10b981; font-size: 16px; font-weight: 600; padding: 15px;">
                    <span id="create-btn-text">🚀 Create Verification</span>
                    <span id="create-loading" style="display: none;">⏳ Creating...</span>
                </button>
                
                <!-- Price Display -->
                <div id="price-display" style="text-align: center; margin-top: 12px; font-size: 14px; color: #94a3b8;">
                    Estimated cost: <span id="estimated-cost">$0.75</span>
                    <div id="price-breakdown"></div>
                </div>
            </div>
            
            <div id="verification-card" class="verification-card">
                <h3>🚀 Verification Active</h3>
                <div style="margin: 10px 0;">Service: <span id="service-name" style="font-weight: 600; text-transform: capitalize;"></span></div>
                <div class="phone-display" id="phone-number" style="font-family: monospace; font-size: 20px; font-weight: bold; background: #f0f9ff; color: #0369a1; padding: 12px; border-radius: 8px; text-align: center; margin: 12px 0; cursor: pointer;" onclick="copyPhone()"></div>
                <div style="margin: 10px 0;">Status: <span id="status" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: #fef3c7; color: #92400e;">pending</span></div>
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn" onclick="checkMessages()" style="background: #10b981; margin-right: 8px;">
                        <span id="check-btn-text">📱 Check Messages</span>
                    </button>
                    <button class="btn btn-danger" onclick="cancelVerification()">
                        ❌ Cancel & Refund
                    </button>
                </div>
                <div style="font-size: 12px; color: #6b7280; text-align: center; margin-top: 10px;">
                    💡 Click phone number to copy • Auto-checking every 10 seconds
                </div>
            </div>
            
            <div id="messages-section" class="messages">
                <h4>SMS Received!</h4>
                <div id="messages-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Fund Wallet Modal -->
    <div id="fund-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div class="card" style="max-width: 400px; margin: 20px;">
            <h3>Fund Wallet</h3>
            <input type="number" id="fund-amount" placeholder="Amount (USD)" min="5" step="5">
            <button class="btn" onclick="processPayment()" style="width: 100%;">Pay with Paystack</button>
            <button class="btn btn-danger" onclick="closeFundWallet()" style="width: 100%; margin-top: 10px;">Cancel</button>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    <div id="loading" class="loading"><div class="spinner"></div></div>
    
    <script>
        const API_BASE = '';
        let currentVerificationId = null;
        let autoRefreshInterval = null;
        
        // Auth Functions
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showNotification('Please enter email and password', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const res = await fetch('/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                showLoading(false);
                
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    showApp();
                    loadUserData();
                    showNotification('Login successful!', 'success');
                } else {
                    showNotification(data.detail || 'Login failed', 'error');
                }
            } catch (err) {
                showLoading(false);
                showNotification('Network error', 'error');
            }
        }
        
        function showRegister() {
            const authCard = document.querySelector('#auth-section .card');
            authCard.innerHTML = `
                <h2>Register</h2>
                <input type="email" id="reg-email" placeholder="Email" required>
                <input type="password" id="reg-password" placeholder="Password (min 6 chars)" required>
                <button class="btn" onclick="register()" style="width: 100%;">Register</button>
                <p style="text-align: center; margin: 10px 0;">or</p>
                <button class="btn" onclick="showLogin()" style="width: 100%; background: #667eea;">Back to Login</button>
            `;
        }
        
        function showLogin() {
            const authCard = document.querySelector('#auth-section .card');
            authCard.innerHTML = `
                <h2>Login</h2>
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button class="btn" onclick="login()" style="width: 100%;">Login</button>
                <p style="text-align: center; margin: 10px 0;">or</p>
                <button class="btn" onclick="showRegister()" style="width: 100%; background: #667eea;">Register</button>
            `;
        }
        
        async function register() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            
            if (!email || !password) {
                showNotification('Please enter email and password', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const res = await fetch('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                showLoading(false);
                
                if (res.ok) {
                    localStorage.setItem('token', data.token);
                    showApp();
                    loadUserData();
                    showNotification('Registration successful! Welcome!', 'success');
                } else {
                    showNotification(data.detail || 'Registration failed', 'error');
                }
            } catch (err) {
                showLoading(false);
                showNotification('Network error', 'error');
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            currentVerificationId = null;
            stopAutoRefresh();
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('verification-card').style.display = 'none';
            document.getElementById('messages-section').style.display = 'none';
            showLogin();
        }
        
        function showApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
        }
        
        async function loadUserData() {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            try {
                const res = await fetch('/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('user-email').textContent = data.email;
                    document.getElementById('user-credits').textContent = (data.credits || 0).toFixed(2);
                } else {
                    console.error('Failed to load user data:', res.status);
                }
            } catch (err) {
                console.error('Failed to load user data:', err);
            }
        }
        
        // Verification Functions
        async function createVerification() {
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('Please login first', 'error');
                return;
            }
            
            const serviceName = document.getElementById('service-select').value;
            const capability = document.querySelector('input[name="capability"]:checked').value;
            const country = document.getElementById('country-select').value;
            
            if (!serviceName) {
                showNotification('Please select a service', 'error');
                return;
            }
            
            const createBtnText = document.getElementById('create-btn-text');
            const createLoading = document.getElementById('create-loading');
            
            createBtnText.style.display = 'none';
            createLoading.style.display = 'inline';
            
            try {
                const res = await fetch('/verify/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        service_name: serviceName,
                        capability: capability,
                        country: country
                    })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    currentVerificationId = data.id;
                    displayVerification(data);
                    document.getElementById('user-credits').textContent = data.remaining_credits.toFixed(2);
                    
                    const capabilityText = capability === 'voice' ? '📞 Voice' : '📱 SMS';
                    showNotification(`${capabilityText} verification created! Cost: N${data.cost}`, 'success');
                    startAutoRefresh();
                } else {
                    if (res.status === 402) {
                        showNotification('Insufficient funds. Please fund your wallet', 'error');
                        showFundWallet();
                    } else {
                        showNotification(data.detail || 'Failed to create verification', 'error');
                    }
                }
            } catch (err) {
                showNotification('Network error', 'error');
            } finally {
                createBtnText.style.display = 'inline';
                createLoading.style.display = 'none';
            }
        }
        
        function displayVerification(data) {
            document.getElementById('service-name').textContent = data.service_name;
            document.getElementById('phone-number').textContent = data.phone_number;
            document.getElementById('status').textContent = data.status;
            
            // Update verification card with capability info
            const verificationCard = document.getElementById('verification-card');
            const capability = data.capability || 'sms';
            const capabilityIcon = capability === 'voice' ? '📞' : '📱';
            const capabilityText = capability === 'voice' ? 'Voice Call' : 'SMS Text';
            
            // Add capability indicator
            const existingCapability = verificationCard.querySelector('.capability-indicator');
            if (existingCapability) {
                existingCapability.remove();
            }
            
            const capabilityDiv = document.createElement('div');
            capabilityDiv.className = 'capability-indicator';
            capabilityDiv.style.cssText = 'background: #f0f9ff; color: #0369a1; padding: 8px 12px; border-radius: 6px; margin: 10px 0; font-size: 14px; font-weight: 600;';
            capabilityDiv.textContent = `${capabilityIcon} ${capabilityText} Verification`;
            
            const phoneDiv = verificationCard.querySelector('.phone-display');
            phoneDiv.parentNode.insertBefore(capabilityDiv, phoneDiv.nextSibling);
            
            verificationCard.style.display = 'block';
            document.getElementById('messages-section').style.display = 'none';
        }
        
        async function checkMessages() {
            if (!currentVerificationId) return;
            
            const token = localStorage.getItem('token');
            
            try {
                // Check if this is a voice verification
                const capability = document.querySelector('.capability-indicator')?.textContent.includes('Voice') ? 'voice' : 'sms';
                const endpoint = capability === 'voice' ? 'voice' : 'messages';
                
                const res = await fetch(`/verify/${currentVerificationId}/${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    
                    if (data.messages && data.messages.length > 0) {
                        stopAutoRefresh();
                        displayMessages(data.messages, capability);
                        const messageType = capability === 'voice' ? 'Voice call' : 'SMS';
                        showNotification(`${messageType} received!`, 'success');
                    } else {
                        const waitingType = capability === 'voice' ? 'voice call' : 'SMS';
                        showNotification(`No ${waitingType} yet. Keep waiting...`, 'error');
                    }
                } else {
                    showNotification('Failed to check messages', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }
        
        function displayMessages(messages, capability = 'sms') {
            const messagesList = document.getElementById('messages-list');
            const isVoice = capability === 'voice';
            const messageType = isVoice ? 'Voice Call' : 'SMS Message';
            const icon = isVoice ? '📞' : '📱';
            
            messagesList.innerHTML = `
                <div style="background: #10b981; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <h3 style="margin: 0 0 8px 0;">${icon} ${messageType} Received!</h3>
                    <p style="margin: 0; opacity: 0.9;">Your verification code has arrived</p>
                </div>
            ` + messages.map(msg => {
                const code = msg.match(/\\b\\d{4,8}\\b/)?.[0] || msg;
                return `
                    <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <strong style="color: #166534;">Verification Code:</strong>
                            <button onclick="copyCode('${code}')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Copy Code</button>
                        </div>
                        <div class="code" onclick="copyCode('${code}')" style="font-family: monospace; font-size: 24px; font-weight: bold; color: #166534; background: white; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; border: 2px dashed #10b981;">${code}</div>
                        <details style="margin-top: 12px;">
                            <summary style="cursor: pointer; color: #6b7280; font-size: 13px;">Full ${messageType.toLowerCase()}</summary>
                            <div style="margin-top: 8px; font-size: 13px; color: #6b7280; background: #f9fafb; padding: 10px; border-radius: 6px;">${msg}</div>
                        </details>
                    </div>
                `;
            }).join('') + `
                <button onclick="tryAnotherService()" style="width: 100%; background: #667eea; color: white; padding: 14px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px;">
                    ✨ Try Another Service
                </button>
            `;
            
            document.getElementById('messages-section').style.display = 'block';
        }
        
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showNotification(`Code ${code} copied!`, 'success');
            });
        }
        
        async function cancelVerification() {
            if (!currentVerificationId) return;
            
            if (!confirm('Cancel verification and get refund?')) return;
            
            const token = localStorage.getItem('token');
            showLoading(true);
            
            try {
                const res = await fetch(`/verify/${currentVerificationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await res.json();
                showLoading(false);
                
                if (res.ok) {
                    document.getElementById('user-credits').textContent = data.new_balance.toFixed(2);
                    showNotification(`Cancelled! Refunded N${data.refunded.toFixed(2)}`, 'success');
                    clearVerification();
                } else {
                    showNotification(data.detail || 'Failed to cancel', 'error');
                }
            } catch (err) {
                showLoading(false);
                showNotification('Network error', 'error');
            }
        }
        
        function clearVerification() {
            currentVerificationId = null;
            stopAutoRefresh();
            document.getElementById('verification-card').style.display = 'none';
            document.getElementById('messages-section').style.display = 'none';
        }
        
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            
            autoRefreshInterval = setInterval(async () => {
                if (currentVerificationId) {
                    await checkMessages();
                }
            }, 10000); // Check every 10 seconds
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Wallet Functions
        function showFundWallet() {
            document.getElementById('fund-modal').classList.remove('hidden');
        }
        
        function closeFundWallet() {
            document.getElementById('fund-modal').classList.add('hidden');
        }
        
        async function processPayment() {
            const amount = parseFloat(document.getElementById('fund-amount').value);
            
            if (!amount || amount < 5) {
                showNotification('Minimum amount is $5', 'error');
                return;
            }
            
            const token = localStorage.getItem('token');
            showLoading(true);
            
            try {
                const res = await fetch('/wallet/fund', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount, method: 'paystack' })
                });
                
                const data = await res.json();
                showLoading(false);
                
                if (res.ok && data.authorization_url) {
                    window.open(data.authorization_url, '_blank');
                    closeFundWallet();
                    showNotification('Payment window opened. Complete payment to fund wallet', 'success');
                } else {
                    showNotification(data.detail || 'Payment failed', 'error');
                }
            } catch (err) {
                showLoading(false);
                showNotification('Network error', 'error');
            }
        }
        
        // Utility Functions
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // Enhanced price calculation with country multipliers
        function updateEstimatedCost() {
            const serviceSelect = document.getElementById('service-select');
            const countrySelect = document.getElementById('country-select');
            const capabilityRadio = document.querySelector('input[name="capability"]:checked');
            
            if (!serviceSelect || !capabilityRadio || !countrySelect) return;
            
            const serviceOption = serviceSelect.options[serviceSelect.selectedIndex];
            const countryOption = countrySelect.options[countrySelect.selectedIndex];
            
            const basePrice = parseFloat(serviceOption.text.match(/\$([0-9.]+)/)?.[1] || '1.00');
            const countryMultiplier = parseFloat(countryOption.text.match(/\(([0-9.]+)x\)/)?.[1] || '1.0');
            const isVoice = capabilityRadio.value === 'voice';
            
            let totalPrice = basePrice * countryMultiplier;
            if (isVoice) totalPrice += 0.30;
            
            document.getElementById('estimated-cost').textContent = `$${totalPrice.toFixed(2)}`;
            
            // Update price breakdown
            const breakdown = document.getElementById('price-breakdown');
            if (breakdown) {
                breakdown.innerHTML = `
                    <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                        Base: $${basePrice} × ${countryMultiplier}x country ${isVoice ? '+ $0.30 voice' : ''}
                    </div>
                `;
            }
        }
        
        // Capability selection styling
        function updateCapabilitySelection() {
            document.querySelectorAll('.capability-option').forEach(option => {
                const radio = option.querySelector('input[type="radio"]');
                if (radio.checked) {
                    option.style.borderColor = '#10b981';
                    option.style.background = '#064e3b';
                } else {
                    option.style.borderColor = '#334155';
                    option.style.background = '#1a2942';
                }
            });
            updateEstimatedCost();
        }
        
        function tryAnotherService() {
            // Clear current verification
            currentVerificationId = null;
            stopAutoRefresh();
            document.getElementById('verification-card').style.display = 'none';
            document.getElementById('messages-section').style.display = 'none';
            
            // Scroll to service selection
            document.getElementById('service-select').scrollIntoView({ behavior: 'smooth' });
            showNotification('Select a new service to verify', 'success');
        }
        
        // Load all available services from TextVerified
        async function loadAllServices() {
            showLoading(true);
            
            try {
                const response = await fetch('/verify/services');
                const data = await response.json();
                
                if (data.services) {
                    showServiceBrowser(data.services);
                } else {
                    showNotification('Unable to load services. Please try again.', 'error');
                }
            } catch (error) {
                showNotification('Network error loading services', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Show service browser modal
        function showServiceBrowser(services) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: #1a2942; border-radius: 12px; padding: 20px; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 100%;';
            
            const header = document.createElement('div');
            header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px;';
            header.innerHTML = `
                <h2 style="color: white; margin: 0;">🔍 Browse All Services (${services.length}+ Available)</h2>
                <button onclick="this.closest('.modal').remove()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">✕ Close</button>
            `;
            
            const searchBox = document.createElement('input');
            searchBox.type = 'text';
            searchBox.placeholder = 'Search services...';
            searchBox.style.cssText = 'width: 100%; padding: 12px; border: 2px solid #334155; background: #0f1f3a; color: white; border-radius: 8px; margin-bottom: 15px;';
            
            const serviceGrid = document.createElement('div');
            serviceGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;';
            
            // Render services
            function renderServices(filteredServices = services) {
                serviceGrid.innerHTML = filteredServices.map(service => `
                    <button onclick="selectService('${service.name}'); this.closest('.modal').remove();" 
                            style="background: #667eea; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; text-align: left; transition: all 0.2s;"
                            onmouseover="this.style.background='#5a67d8'" onmouseout="this.style.background='#667eea'">
                        <div style="font-weight: 600;">${service.name}</div>
                        <div style="font-size: 12px; opacity: 0.8;">$${service.price} ${service.voice_supported ? '📞' : '📱'}</div>
                    </button>
                `).join('');
            }
            
            // Search functionality
            searchBox.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = services.filter(s => s.name.toLowerCase().includes(query));
                renderServices(filtered);
            });
            
            renderServices();
            
            content.appendChild(header);
            content.appendChild(searchBox);
            content.appendChild(serviceGrid);
            modal.appendChild(content);
            modal.className = 'modal';
            
            document.body.appendChild(modal);
        }
        
        // Select service from browser
        function selectService(serviceName) {
            const serviceSelect = document.getElementById('service-select');
            
            // Check if service exists in dropdown
            const option = Array.from(serviceSelect.options).find(opt => opt.value === serviceName);
            
            if (option) {
                serviceSelect.value = serviceName;
            } else {
                // Add new option if not in dropdown
                const newOption = document.createElement('option');
                newOption.value = serviceName;
                newOption.textContent = `🔍 ${serviceName} - Custom`;
                serviceSelect.appendChild(newOption);
                serviceSelect.value = serviceName;
            }
            
            updateEstimatedCost();
            showNotification(`Selected ${serviceName} for verification`, 'success');
        }
        
        function copyPhone() {
            const phone = document.getElementById('phone-number').textContent;
            if (phone && phone !== 'Loading...') {
                navigator.clipboard.writeText(phone).then(() => {
                    showNotification('📱 Phone number copied to clipboard!', 'success');
                }).catch(() => {
                    showNotification('Failed to copy phone number', 'error');
                });
            }
        }
        
        // Auto-detect user country
        function detectUserCountry() {
            try {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const countryMap = {
                    'America/New_York': 'US', 'America/Los_Angeles': 'US', 'America/Chicago': 'US',
                    'Europe/London': 'GB', 'Europe/Berlin': 'DE', 'Europe/Paris': 'FR',
                    'Europe/Amsterdam': 'NL', 'Europe/Stockholm': 'SE', 'Europe/Oslo': 'NO',
                    'Asia/Tokyo': 'JP', 'Asia/Singapore': 'SG', 'Asia/Hong_Kong': 'HK',
                    'Australia/Sydney': 'AU', 'America/Toronto': 'CA'
                };
                
                for (const [tz, country] of Object.entries(countryMap)) {
                    if (timezone.includes(tz.split('/')[1])) {
                        const countrySelect = document.getElementById('country-select');
                        if (countrySelect) {
                            countrySelect.value = country;
                            updateEstimatedCost();
                        }
                        break;
                    }
                }
            } catch (e) {
                // Fallback to US if detection fails
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (token) {
                showApp();
                loadUserData();
            }
            
            // Auto-detect user country
            detectUserCountry();
            
            // Load service count
            loadServiceCount();
            
            // Add event listeners for price updates
            setTimeout(() => {
                const serviceSelect = document.getElementById('service-select');
                const countrySelect = document.getElementById('country-select');
                
                if (serviceSelect) {
                    serviceSelect.addEventListener('change', updateEstimatedCost);
                }
                
                if (countrySelect) {
                    countrySelect.addEventListener('change', updateEstimatedCost);
                }
                
                document.querySelectorAll('input[name="capability"]').forEach(radio => {
                    radio.addEventListener('change', updateCapabilitySelection);
                });
                
                // Initialize capability selection styling
                updateCapabilitySelection();
            }, 100);
        });
        
        // Auto-refresh user data every 30 seconds
        setInterval(() => {
            if (localStorage.getItem('token')) {
                loadUserData();
            }
        }, 30000);
    </script>

    <script src="/static/js/enhanced-verification.js"></script>
    <script src="/ws/client.js"></script>
    <script>
        // Enhanced WebSocket integration
        function startRealtimeMonitoring(verificationId) {
            if (typeof connectWebSocket === 'function') {
                connectWebSocket(verificationId);
            }
        }
        
        // Override verification manager to use WebSocket
        const originalCreateVerification = verificationManager.createVerification;
        verificationManager.createVerification = async function() {
            const result = await originalCreateVerification.call(this);
            if (this.currentVerificationId) {
                startRealtimeMonitoring(this.currentVerificationId);
            }
            return result;
        };
    </script>
</body>
</html>