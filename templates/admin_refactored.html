<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Admin Dashboard - Namaskah SMS</title>
    <link rel="stylesheet" href="/static/css/enhanced-dashboard.css">
    <style>
        .admin-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .admin-header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .admin-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .admin-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .admin-table th,
        .admin-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .admin-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .admin-table tr:hover {
            background: #f9fafb;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-healthy {
            background: #d1fae5;
            color: #065f46;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .search-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-admin {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-admin.primary { background: #667eea; color: white; }
        .btn-admin.success { background: #10b981; color: white; }
        .btn-admin.danger { background: #ef4444; color: white; }
        .btn-admin.warning { background: #f59e0b; color: white; }

        .real-time-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #10b981;
        }

        .chart-container {
            height: 300px;
            background: #f9fafb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .error-boundary {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Enhanced Header -->
        <div class="admin-header">
            <div>
                <h1>üéõÔ∏è Enhanced Admin Dashboard</h1>
                <div class="real-time-indicator">
                    <div class="status-dot active"></div>
                    Real-time monitoring active
                </div>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div id="system-health" class="status-indicator status-healthy">
                    System Healthy
                </div>
                <button class="btn-admin danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Enhanced Stats Grid -->
        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-value" id="stat-users">0</div>
                <div class="stat-label">Total Users</div>
                <div class="stat-change" id="stat-users-change">+0 this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-revenue">N0</div>
                <div class="stat-label">Total Revenue</div>
                <div class="stat-change" id="stat-revenue-change">+N0 this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-verifications">0</div>
                <div class="stat-label">Active Verifications</div>
                <div class="stat-change" id="stat-verifications-change">0 pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-success">0%</div>
                <div class="stat-label">Success Rate</div>
                <div class="stat-change" id="stat-success-change">Last 7 days</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-errors">0</div>
                <div class="stat-label">System Errors</div>
                <div class="stat-change" id="stat-errors-change">Last 24h</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-api-calls">0</div>
                <div class="stat-label">API Calls</div>
                <div class="stat-change" id="stat-api-change">Per minute</div>
            </div>
        </div>

        <!-- Enhanced Main Content -->
        <div class="admin-card">
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchTab('users')">üë• Users</button>
                <button class="admin-tab" onclick="switchTab('verifications')">üì± Verifications</button>
                <button class="admin-tab" onclick="switchTab('payments')">üí∞ Payments</button>
                <button class="admin-tab" onclick="switchTab('analytics')">üìä Analytics</button>
                <button class="admin-tab" onclick="switchTab('monitoring')">üîç Monitoring</button>
                <button class="admin-tab" onclick="switchTab('system')">‚öôÔ∏è System</button>
            </div>

            <!-- Enhanced Users Tab -->
            <div id="users-tab" class="tab-content active">
                <div class="search-filters">
                    <input type="text" class="filter-input" placeholder="Search users..." 
                           onkeyup="searchUsers(this.value)">
                    <select class="filter-input" onchange="filterByPlan(this.value)">
                        <option value="all">All Plans</option>
                        <option value="free">Free Plan</option>
                        <option value="developer">Developer</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                    <select class="filter-input" onchange="filterByStatus(this.value)">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="suspended">Suspended</option>
                    </select>
                    <button class="btn-admin primary" onclick="exportUsers()">üìä Export</button>
                    <button class="btn-admin success" onclick="refreshUsers()">üîÑ Refresh</button>
                </div>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Plan</th>
                            <th>Credits</th>
                            <th>Spent</th>
                            <th>Verifications</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table"></tbody>
                </table>
            </div>

            <!-- Enhanced Verifications Tab -->
            <div id="verifications-tab" class="tab-content">
                <div class="search-filters">
                    <select class="filter-input" onchange="filterVerifications(this.value)">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <input type="text" class="filter-input" placeholder="Service name..." 
                           onkeyup="filterByService(this.value)">
                    <button class="btn-admin success" onclick="refreshVerifications()">üîÑ Refresh</button>
                </div>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Service</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Cost</th>
                            <th>Created</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="verifications-table"></tbody>
                </table>
            </div>

            <!-- Enhanced Monitoring Tab -->
            <div id="monitoring-tab" class="tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>üìä Performance Metrics</h3>
                        <div id="performance-metrics"></div>
                    </div>
                    <div>
                        <h3>üö® Recent Errors</h3>
                        <div id="error-log"></div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3>üîç Production Health</h3>
                    <div id="health-status"></div>
                </div>
            </div>

            <!-- System Tab -->
            <div id="system-tab" class="tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>‚öôÔ∏è System Configuration</h3>
                        <div id="system-config"></div>
                    </div>
                    <div>
                        <h3>üîß Maintenance Tools</h3>
                        <div class="maintenance-tools">
                            <button class="btn-admin warning" onclick="clearCache()">üóëÔ∏è Clear Cache</button>
                            <button class="btn-admin primary" onclick="resetCircuitBreakers()">üîÑ Reset Circuit Breakers</button>
                            <button class="btn-admin danger" onclick="emergencyMaintenance()">üö® Emergency Mode</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other tabs (payments, analytics) remain similar but enhanced -->
            <div id="payments-tab" class="tab-content">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>Reference</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payments-table"></tbody>
                </table>
            </div>

            <div id="analytics-tab" class="tab-content">
                <div class="chart-container" id="revenue-chart">
                    üìä Revenue Analytics Loading...
                </div>
                <div class="chart-container" id="users-chart">
                    üìà User Growth Analytics Loading...
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Modals -->
    <div id="user-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë§ User Management</h3>
                <button class="modal-close" onclick="closeModal('user-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="user-details"></div>
                <div class="user-actions">
                    <button class="btn-admin success" onclick="fundUser()">üí∞ Fund</button>
                    <button class="btn-admin danger" onclick="debitUser()">üí∏ Debit</button>
                    <button class="btn-admin warning" onclick="suspendUser()">üö´ Suspend</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Boundary -->
    <div id="error-boundary" class="error-boundary" style="display: none;">
        <h3>‚ö†Ô∏è Application Error</h3>
        <p id="error-message"></p>
        <button class="btn-admin primary" onclick="recoverFromError()">üîÑ Retry</button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Scripts -->
    <script src="/static/js/performance-monitor.js"></script>
    <script src="/static/js/error-tracker.js"></script>
    <script src="/static/js/notification-system.js"></script>

    <script>
        // Enhanced Admin Controller
        class EnhancedAdminController {
            constructor() {
                this.token = localStorage.getItem('admin_token') || localStorage.getItem('token');
                this.headers = { 'Authorization': `Bearer ${this.token}` };
                this.allUsers = [];
                this.allVerifications = [];
                this.currentTab = 'users';
                this.refreshIntervals = {};
                this.init();
            }

            async init() {
                if (!this.token) {
                    this.showLogin();
                    return;
                }

                try {
                    await this.verifyAdminAccess();
                    this.setupEventListeners();
                    this.startRealTimeUpdates();
                    await this.loadInitialData();
                } catch (error) {
                    this.handleError('Initialization failed', error);
                }
            }

            async verifyAdminAccess() {
                try {
                    const response = await fetch('/auth/me', { headers: this.headers });
                    const user = await response.json();
                    
                    if (!response.ok || !user.is_admin) {
                        throw new Error('Admin access required');
                    }
                } catch (error) {
                    this.showLogin();
                    throw error;
                }
            }

            showLogin() {
                document.body.innerHTML = `
                    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 400px; width: 90%;">
                            <h1 style="color: #667eea; margin-bottom: 30px; text-align: center;">üéõÔ∏è Enhanced Admin</h1>
                            <input type="email" id="admin-email" placeholder="Email" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e5e7eb; border-radius: 8px;" onkeypress="if(event.key==='Enter')this.adminLogin()">
                            <input type="password" id="admin-password" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #e5e7eb; border-radius: 8px;" onkeypress="if(event.key==='Enter')this.adminLogin()">
                            <button onclick="this.adminLogin()" style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Login</button>
                            <div id="admin-error" style="color: #ef4444; margin-top: 15px; text-align: center; display: none;"></div>
                        </div>
                    </div>
                `;

                window.adminLogin = async () => {
                    const email = document.getElementById('admin-email').value;
                    const password = document.getElementById('admin-password').value;
                    const errorDiv = document.getElementById('admin-error');
                    
                    try {
                        const res = await fetch('/auth/login', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({email, password})
                        });
                        
                        const data = await res.json();
                        
                        if (res.ok && data.token && data.is_admin) {
                            localStorage.setItem('admin_token', data.token);
                            window.location.reload();
                        } else {
                            errorDiv.textContent = 'Admin access required';
                            errorDiv.style.display = 'block';
                        }
                    } catch (error) {
                        errorDiv.textContent = 'Login failed';
                        errorDiv.style.display = 'block';
                    }
                };
            }

            setupEventListeners() {
                // Error boundary
                window.addEventListener('error', (event) => {
                    this.showErrorBoundary(event.error);
                });

                window.addEventListener('unhandledrejection', (event) => {
                    this.showErrorBoundary(event.reason);
                });
            }

            startRealTimeUpdates() {
                // Real-time stats updates
                this.refreshIntervals.stats = setInterval(() => {
                    this.loadStats();
                }, 30000);

                // Real-time health monitoring
                this.refreshIntervals.health = setInterval(() => {
                    this.checkSystemHealth();
                }, 15000);

                // Initial health check
                this.checkSystemHealth();
            }

            async loadInitialData() {
                this.showLoading(true);
                
                try {
                    await Promise.all([
                        this.loadStats(),
                        this.loadUsers(),
                        this.loadProductionMetrics()
                    ]);
                } catch (error) {
                    this.handleError('Failed to load initial data', error);
                } finally {
                    this.showLoading(false);
                }
            }

            async loadStats() {
                try {
                    const response = await fetch('/admin/stats?period=7', { headers: this.headers });
                    const data = await response.json();
                    
                    this.updateStatsDisplay(data);
                } catch (error) {
                    this.handleError('Failed to load stats', error);
                }
            }

            updateStatsDisplay(data) {
                const elements = {
                    'stat-users': data.total_users,
                    'stat-users-change': `+${data.new_users} this week`,
                    'stat-revenue': `N${data.total_revenue.toFixed(2)}`,
                    'stat-revenue-change': `+N${data.revenue_change.toFixed(2)} this week`,
                    'stat-verifications': data.total_verifications,
                    'stat-verifications-change': `${data.pending_verifications} pending`,
                    'stat-success': `${data.success_rate}%`,
                    'stat-success-change': 'Last 7 days'
                };

                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                });
            }

            async loadUsers() {
                try {
                    const response = await fetch('/admin/users?limit=100', { headers: this.headers });
                    const data = await response.json();
                    
                    this.allUsers = data.users;
                    this.renderUsers(this.allUsers);
                } catch (error) {
                    this.handleError('Failed to load users', error);
                }
            }

            renderUsers(users) {
                const tbody = document.getElementById('users-table');
                if (!tbody) return;

                tbody.innerHTML = users.map(user => {
                    const plan = this.getUserPlan(user);
                    const status = this.getUserStatus(user);
                    
                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${user.email}</div>
                                <div style="font-size: 11px; color: #6b7280;">ID: ${user.id.substring(0, 20)}...</div>
                            </td>
                            <td><span class="badge badge-${plan}">${plan.toUpperCase()}</span></td>
                            <td style="font-weight: 600; color: #10b981;">N${user.credits.toFixed(2)}</td>
                            <td style="color: #ef4444;">N${(user.total_spent || 0).toFixed(2)}</td>
                            <td>${user.verification_count || 0}</td>
                            <td><span class="status-indicator status-${status}">${status}</span></td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-admin success" onclick="adminController.quickAction('fund', '${user.id}')">üí∞</button>
                                    <button class="btn-admin danger" onclick="adminController.quickAction('debit', '${user.id}')">üí∏</button>
                                    <button class="btn-admin primary" onclick="adminController.viewUser('${user.id}')">üëÅÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            async loadProductionMetrics() {
                try {
                    const response = await fetch('/admin/production/metrics', { headers: this.headers });
                    const data = await response.json();
                    
                    this.updateProductionMetrics(data);
                } catch (error) {
                    console.warn('Production metrics not available:', error);
                }
            }

            updateProductionMetrics(data) {
                // Update error count
                const errorElement = document.getElementById('stat-errors');
                if (errorElement) {
                    errorElement.textContent = data.error_count || 0;
                }

                // Update API calls
                const apiElement = document.getElementById('stat-api-calls');
                if (apiElement) {
                    apiElement.textContent = data.recent_metrics || 0;
                }
            }

            async checkSystemHealth() {
                try {
                    const response = await fetch('/admin/production/health', { headers: this.headers });
                    const health = await response.json();
                    
                    this.updateSystemHealth(health);
                } catch (error) {
                    this.updateSystemHealth({ status: 'error', message: 'Health check failed' });
                }
            }

            updateSystemHealth(health) {
                const indicator = document.getElementById('system-health');
                if (!indicator) return;

                const statusClass = health.status === 'healthy' ? 'status-healthy' : 
                                  health.status === 'degraded' ? 'status-warning' : 'status-error';
                
                indicator.className = `status-indicator ${statusClass}`;
                indicator.textContent = `System ${health.status}`;
            }

            // Tab management
            switchTab(tab) {
                // Update active tab
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                event.target.classList.add('active');
                document.getElementById(`${tab}-tab`).classList.add('active');

                this.currentTab = tab;

                // Load tab-specific data
                switch (tab) {
                    case 'verifications':
                        this.loadVerifications();
                        break;
                    case 'payments':
                        this.loadPayments();
                        break;
                    case 'monitoring':
                        this.loadMonitoring();
                        break;
                    case 'system':
                        this.loadSystemInfo();
                        break;
                }
            }

            // Utility methods
            getUserPlan(user) {
                const funded = user.credits + Math.abs(user.total_spent || 0);
                if (funded >= 100) return 'enterprise';
                if (funded >= 25) return 'developer';
                return 'free';
            }

            getUserStatus(user) {
                if (!user.email_verified) return 'inactive';
                return 'active';
            }

            showLoading(show) {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.style.display = show ? 'flex' : 'none';
                }
            }

            showErrorBoundary(error) {
                const boundary = document.getElementById('error-boundary');
                const message = document.getElementById('error-message');
                
                if (boundary && message) {
                    message.textContent = error.message || 'An unexpected error occurred';
                    boundary.style.display = 'block';
                }
            }

            handleError(message, error) {
                console.error(message, error);
                
                if (window.showNotification) {
                    window.showNotification(`${message}: ${error.message}`, 'error');
                }

                // Log to error tracker
                if (window.errorTracker) {
                    window.errorTracker.logError({
                        type: 'admin_error',
                        message: message,
                        details: error.message,
                        timestamp: Date.now()
                    });
                }
            }

            logout() {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('token');
                window.location.reload();
            }
        }

        // Global functions
        window.switchTab = function(tab) {
            if (window.adminController) {
                window.adminController.switchTab(tab);
            }
        };

        window.logout = function() {
            if (window.adminController) {
                window.adminController.logout();
            }
        };

        window.recoverFromError = function() {
            document.getElementById('error-boundary').style.display = 'none';
            window.location.reload();
        };

        // Initialize admin controller
        document.addEventListener('DOMContentLoaded', () => {
            window.adminController = new EnhancedAdminController();
        });
    </script>
</body>
</html>