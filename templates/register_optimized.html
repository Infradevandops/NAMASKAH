<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Namaskah SMS</title>
    <link rel="stylesheet" href="/static/css/auth.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>üì± Namaskah SMS</h1>
                <p>Create your account to get started</p>
            </div>

            <form id="register-form" class="auth-form register-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required minlength="6">
                    <div id="password-strength" class="password-strength"></div>
                </div>

                <div class="form-group">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" name="confirm-password" required>
                </div>

                <div class="form-group">
                    <label for="referral-code">Referral Code (Optional)</label>
                    <input type="text" id="referral-code" name="referral-code" placeholder="Enter referral code">
                </div>

                <div class="terms-checkbox">
                    <input type="checkbox" id="terms" required>
                    <label for="terms">
                        I agree to the <a href="/terms" target="_blank">Terms of Service</a> 
                        and <a href="/privacy" target="_blank">Privacy Policy</a>
                    </label>
                </div>

                <button type="submit" class="btn-primary" id="register-btn">
                    Create Account
                </button>
            </form>

            <div class="divider">
                <span>or</span>
            </div>

            <div id="google-signin-container">
                <div id="g_id_onload"
                     data-client_id=""
                     data-callback="handleGoogleSignIn"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="signup_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>
            </div>

            <div class="auth-links">
                <span>Already have an account?</span>
                <a href="/login">Sign In</a>
            </div>

            <div class="features-preview">
                <h3>üéÅ What You Get</h3>
                <ul>
                    <li>‚úÖ 1 free verification to start</li>
                    <li>üöÄ Smart routing for 95%+ success</li>
                    <li>üí∞ Dynamic pricing optimization</li>
                    <li>üìä Real-time analytics dashboard</li>
                    <li>‚ö° API access for developers</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        class RegisterManager {
            constructor() {
                this.setupEventListeners();
                this.loadGoogleConfig();
            }

            async loadGoogleConfig() {
                try {
                    const response = await fetch('/auth/google/config');
                    const config = await response.json();
                    
                    if (config.enabled && config.client_id) {
                        document.querySelector('[data-client_id]').setAttribute('data-client_id', config.client_id);
                    } else {
                        document.getElementById('google-signin-container').style.display = 'none';
                    }
                } catch (error) {
                    document.getElementById('google-signin-container').style.display = 'none';
                }
            }

            setupEventListeners() {
                document.getElementById('register-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleRegister();
                });

                // Password strength indicator
                document.getElementById('password').addEventListener('input', (e) => {
                    this.updatePasswordStrength(e.target.value);
                });

                // Password confirmation
                document.getElementById('confirm-password').addEventListener('input', (e) => {
                    this.validatePasswordMatch();
                });

                // Auto-fill referral code from URL
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref');
                if (refCode) {
                    document.getElementById('referral-code').value = refCode;
                }
            }

            updatePasswordStrength(password) {
                const strengthEl = document.getElementById('password-strength');
                let strength = 0;
                let feedback = [];

                if (password.length >= 8) strength++;
                else feedback.push('At least 8 characters');

                if (/[A-Z]/.test(password)) strength++;
                else feedback.push('One uppercase letter');

                if (/[0-9]/.test(password)) strength++;
                else feedback.push('One number');

                if (/[^A-Za-z0-9]/.test(password)) strength++;
                else feedback.push('One special character');

                const levels = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
                const classes = ['strength-weak', 'strength-weak', 'strength-medium', 'strength-medium', 'strength-strong'];

                strengthEl.textContent = levels[strength] || 'Very Weak';
                strengthEl.className = `password-strength ${classes[strength] || 'strength-weak'}`;

                if (feedback.length > 0 && password.length > 0) {
                    strengthEl.textContent += ` (Need: ${feedback.join(', ')})`;
                }
            }

            validatePasswordMatch() {
                const password = document.getElementById('password').value;
                const confirm = document.getElementById('confirm-password').value;
                const confirmEl = document.getElementById('confirm-password');

                if (confirm && password !== confirm) {
                    confirmEl.setCustomValidity('Passwords do not match');
                } else {
                    confirmEl.setCustomValidity('');
                }
            }

            async handleRegister() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const referralCode = document.getElementById('referral-code').value;
                const registerBtn = document.getElementById('register-btn');

                if (password !== confirmPassword) {
                    this.showError('Passwords do not match');
                    return;
                }

                if (password.length < 6) {
                    this.showError('Password must be at least 6 characters');
                    return;
                }

                registerBtn.disabled = true;
                registerBtn.innerHTML = '<span class="loading"></span>Creating account...';

                try {
                    const payload = { email, password };
                    const url = referralCode ? 
                        `/auth/register?referral_code=${referralCode}` : 
                        '/auth/register';

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user_id', data.user_id);
                        
                        this.showSuccess('Account created successfully! Redirecting...');
                        
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1500);
                    } else {
                        this.showError(data.detail || 'Registration failed');
                    }
                } catch (error) {
                    this.showError('Network error. Please try again.');
                } finally {
                    registerBtn.disabled = false;
                    registerBtn.textContent = 'Create Account';
                }
            }

            showError(message) {
                this.showMessage(message, 'error-message');
            }

            showSuccess(message) {
                this.showMessage(message, 'success-message');
            }

            showMessage(message, className) {
                const existing = document.querySelector('.error-message, .success-message');
                if (existing) existing.remove();

                const messageDiv = document.createElement('div');
                messageDiv.className = className;
                messageDiv.textContent = message;
                
                document.querySelector('.auth-form').appendChild(messageDiv);
                
                if (className === 'error-message') {
                    setTimeout(() => messageDiv.remove(), 5000);
                }
            }
        }

        // Google Sign-In callback
        async function handleGoogleSignIn(response) {
            try {
                const result = await fetch('/auth/google', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: response.credential })
                });

                const data = await result.json();

                if (result.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user_id', data.user_id);
                    
                    register.showSuccess('Account created successfully! Redirecting...');
                    
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1500);
                } else {
                    register.showError(data.detail || 'Google sign-up failed');
                }
            } catch (error) {
                register.showError('Google sign-up error. Please try again.');
            }
        }

        // Initialize
        const register = new RegisterManager();

        // Check if already logged in
        if (localStorage.getItem('token')) {
            window.location.href = '/dashboard';
        }
    </script>
</body>
</html>