<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Namaskah SMS - Enhanced Dashboard</title>
    <link rel="stylesheet" href="/static/css/enhanced-dashboard.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <h1>Namaskah SMS</h1>
                <div class="user-info">
                    <span id="user-credits">N0.00</span>
                    <button id="logout-btn" class="btn-secondary">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Enhanced Verification Section -->
            <section class="verification-section">
                <div class="section-header">
                    <h2>Smart Verification</h2>
                    <div class="status-indicators">
                        <div id="api-status" class="status-dot active" title="API Status"></div>
                        <div id="websocket-status" class="status-dot inactive" title="Real-time Updates"></div>
                    </div>
                </div>

                <div id="smart-verification-form" class="verification-form">
                    <!-- Service Selection with Search -->
                    <div class="form-group">
                        <label for="service-search">Select Service</label>
                        <div class="service-search-container">
                            <input type="text" id="service-search" placeholder="Search services..." 
                                   oninput="filterServices(this.value)">
                            <select id="service-select" class="service-dropdown">
                                <option value="">Loading services...</option>
                            </select>
                        </div>
                        <div id="tier-badge" class="tier-badge" style="display: none;"></div>
                    </div>

                    <!-- Enhanced Pricing Display -->
                    <div class="pricing-display">
                        <div class="price-main">
                            <span class="price-label">Current Price:</span>
                            <strong id="current-price" class="price-value">N0.00</strong>
                        </div>
                        
                        <div class="price-details">
                            <div id="base-price-container" style="display: none;">
                                <span class="price-label">Base Price:</span>
                                <span id="base-price" class="price-crossed">N0.00</span>
                            </div>
                            
                            <div id="savings" class="savings hidden">
                                <span class="savings-text">Save N0.00</span>
                            </div>
                        </div>

                        <div id="timing-tip" class="timing-tip" style="display: none;"></div>
                        <div id="optimization-tips" class="optimization-tips" style="display: none;"></div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="advanced-preferences">
                        <h4>Advanced Options</h4>
                        
                        <div class="preference-row">
                            <div class="form-group">
                                <label for="carrier-select">Preferred Carrier (+$0.25)</label>
                                <select id="carrier-select">
                                    <option value="">Any Carrier</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="area-code">Area Code (+$4.00)</label>
                                <input type="text" id="area-code" placeholder="e.g., 212" maxlength="3">
                            </div>
                        </div>

                        <div class="optimization-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="auto-optimize" checked>
                                <span class="checkmark"></span>
                                Auto-optimize for best success rate
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="checkbox" id="priority-processing">
                                <span class="checkmark"></span>
                                Priority processing (+$0.50)
                            </label>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <button id="create-verification-btn" class="btn-primary verification-btn">
                        Create Verification
                    </button>
                </div>
            </section>

            <!-- Active Verifications with Real-time Updates -->
            <section class="verifications-section">
                <div class="section-header">
                    <h3>Active Verifications</h3>
                    <div class="section-controls">
                        <button id="refresh-verifications" class="btn-secondary">Refresh</button>
                        <label class="checkbox-label">
                            <input type="checkbox" id="auto-refresh" checked>
                            Auto-refresh
                        </label>
                    </div>
                </div>
                
                <div id="active-verifications" class="verifications-list">
                    <div class="loading-state">Loading verifications...</div>
                </div>
            </section>

            <!-- Enhanced Stats -->
            <section class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-verifications">0</div>
                        <div class="stat-label">Total Verifications</div>
                        <div class="stat-change" id="verifications-change">+0 this week</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="success-rate">0%</div>
                        <div class="stat-label">Success Rate</div>
                        <div class="stat-change" id="success-change">Last 30 days</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="total-spent">N0.00</div>
                        <div class="stat-label">Total Spent</div>
                        <div class="stat-change" id="spent-change">+N0 this month</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="avg-time">--</div>
                        <div class="stat-label">Avg. Delivery Time</div>
                        <div class="stat-change">Seconds</div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Enhanced Sidebar -->
        <aside class="dashboard-sidebar">
            <nav class="sidebar-nav">
                <a href="/app" class="nav-item active">
                    <span class="nav-icon">üì±</span>
                    Dashboard
                </a>
                <a href="/dashboard/enhanced" class="nav-item">
                    <span class="nav-icon">‚ö°</span>
                    Enhanced
                </a>
                <a href="/analytics" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    Analytics
                </a>
                <a href="#" class="nav-item" onclick="showWalletModal()">
                    <span class="nav-icon">üí∞</span>
                    Fund Wallet
                </a>
                <a href="#" class="nav-item" onclick="showHistoryModal()">
                    <span class="nav-icon">üìã</span>
                    History
                </a>
            </nav>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h4>Quick Verify</h4>
                <button class="quick-btn" onclick="quickVerify('whatsapp')">
                    <span class="service-icon">üì±</span>
                    WhatsApp
                </button>
                <button class="quick-btn" onclick="quickVerify('telegram')">
                    <span class="service-icon">‚úàÔ∏è</span>
                    Telegram
                </button>
                <button class="quick-btn" onclick="quickVerify('discord')">
                    <span class="service-icon">üéÆ</span>
                    Discord
                </button>
                <button class="quick-btn" onclick="quickVerify('google')">
                    <span class="service-icon">üîç</span>
                    Google
                </button>
            </div>

            <!-- System Status -->
            <div class="system-status">
                <h4>System Status</h4>
                <div class="status-item">
                    <span>API Health</span>
                    <div id="api-health" class="status-dot active"></div>
                </div>
                <div class="status-item">
                    <span>SMS Provider</span>
                    <div id="sms-health" class="status-dot active"></div>
                </div>
                <div class="status-item">
                    <span>Payment System</span>
                    <div id="payment-health" class="status-dot active"></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Enhanced Modals -->
    <div id="wallet-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Fund Wallet</h3>
                <button class="modal-close" onclick="closeModal('wallet-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="funding-options">
                    <div class="funding-option">
                        <h4>Paystack Payment</h4>
                        <p>Pay with card, bank transfer, or mobile money</p>
                        <div class="amount-input">
                            <label>Amount (USD):</label>
                            <input type="number" id="fund-amount" min="5" step="0.01" placeholder="5.00">
                            <div class="conversion-info">
                                <small>‚âà N<span id="ngn-equivalent">0.00</span> NGN</small>
                            </div>
                        </div>
                        <button class="btn-primary" onclick="initializePayment()">
                            Pay with Paystack
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Verification History</h3>
                <button class="modal-close" onclick="closeModal('history-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="history-filters">
                    <select id="history-filter">
                        <option value="all">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <select id="history-service">
                        <option value="all">All Services</option>
                    </select>
                </div>
                <div id="history-list" class="history-list">
                    Loading history...
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Error</h3>
                <button class="modal-close" onclick="closeModal('error-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="error-message"></div>
                <div class="error-actions">
                    <button class="btn-primary" onclick="retryLastAction()">Retry</button>
                    <button class="btn-secondary" onclick="closeModal('error-modal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Scripts -->
    <script src="/static/js/performance-monitor.js"></script>
    <script src="/static/js/error-tracker.js"></script>
    <script src="/static/js/cache-manager.js"></script>
    <script src="/static/js/smart-verification.js"></script>
    <script src="/static/js/enhanced-dashboard.js"></script>
    <script src="/static/js/notification-system.js"></script>

    <script>
        // Enhanced App Controller
        class EnhancedAppController {
            constructor() {
                this.user = null;
                this.services = [];
                this.carriers = [];
                this.lastAction = null;
                this.init();
            }

            async init() {
                try {
                    await this.loadUser();
                    await this.loadServices();
                    await this.loadCarriers();
                    this.setupEventListeners();
                    this.startHealthChecks();
                } catch (error) {
                    this.handleError('Initialization failed', error);
                }
            }

            async loadUser() {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                try {
                    const response = await fetch('/auth/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        throw new Error('Authentication failed');
                    }

                    this.user = await response.json();
                    this.updateUserDisplay();
                } catch (error) {
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                }
            }

            async loadServices() {
                try {
                    const services = await window.cacheManager.getServices();
                    this.services = services;
                    this.populateServiceDropdown();
                } catch (error) {
                    this.handleError('Failed to load services', error);
                }
            }

            async loadCarriers() {
                try {
                    const carriers = await window.cacheManager.getCarriers();
                    this.carriers = carriers.carriers || [];
                    this.populateCarrierDropdown();
                } catch (error) {
                    console.warn('Carriers not available:', error);
                }
            }

            populateServiceDropdown() {
                const select = document.getElementById('service-select');
                if (!select) return;

                select.innerHTML = '<option value="">Select Service</option>';

                // Add popular services first
                if (this.services.categories && this.services.categories.popular) {
                    const popularGroup = document.createElement('optgroup');
                    popularGroup.label = 'Popular Services';
                    
                    this.services.categories.popular.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service;
                        option.textContent = this.formatServiceName(service);
                        popularGroup.appendChild(option);
                    });
                    
                    select.appendChild(popularGroup);
                }

                // Add other categories
                Object.entries(this.services.categories || {}).forEach(([category, services]) => {
                    if (category === 'popular') return;
                    
                    const group = document.createElement('optgroup');
                    group.label = this.formatCategoryName(category);
                    
                    services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service;
                        option.textContent = this.formatServiceName(service);
                        group.appendChild(option);
                    });
                    
                    select.appendChild(group);
                });
            }

            populateCarrierDropdown() {
                const select = document.getElementById('carrier-select');
                if (!select || !this.carriers.length) return;

                // Add popular carriers first
                this.carriers.filter(c => c.popular).forEach(carrier => {
                    const option = document.createElement('option');
                    option.value = carrier.value;
                    option.textContent = `${carrier.label} (+$0.25)`;
                    select.appendChild(option);
                });

                // Add separator
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                select.appendChild(separator);

                // Add other carriers
                this.carriers.filter(c => !c.popular).forEach(carrier => {
                    const option = document.createElement('option');
                    option.value = carrier.value;
                    option.textContent = `${carrier.label} (+$0.25)`;
                    select.appendChild(option);
                });
            }

            setupEventListeners() {
                // Service selection
                const serviceSelect = document.getElementById('service-select');
                if (serviceSelect) {
                    serviceSelect.addEventListener('change', (e) => {
                        this.handleServiceChange(e.target.value);
                    });
                }

                // Service search
                const serviceSearch = document.getElementById('service-search');
                if (serviceSearch) {
                    serviceSearch.addEventListener('input', (e) => {
                        this.filterServices(e.target.value);
                    });
                }

                // Pricing updates
                const carrierSelect = document.getElementById('carrier-select');
                const areaCodeInput = document.getElementById('area-code');
                
                if (carrierSelect) {
                    carrierSelect.addEventListener('change', () => this.updatePricing());
                }
                
                if (areaCodeInput) {
                    areaCodeInput.addEventListener('input', () => this.updatePricing());
                }

                // Create verification
                const createBtn = document.getElementById('create-verification-btn');
                if (createBtn) {
                    createBtn.addEventListener('click', () => this.createVerification());
                }

                // Logout
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.logout());
                }

                // Auto-refresh toggle
                const autoRefresh = document.getElementById('auto-refresh');
                if (autoRefresh) {
                    autoRefresh.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            this.startAutoRefresh();
                        } else {
                            this.stopAutoRefresh();
                        }
                    });
                }
            }

            async handleServiceChange(serviceName) {
                if (!serviceName) {
                    this.clearPricing();
                    return;
                }

                await this.updatePricing(serviceName);
                this.showServiceTips(serviceName);
            }

            async updatePricing(serviceName = null) {
                const service = serviceName || document.getElementById('service-select').value;
                if (!service) return;

                try {
                    const pricing = await window.cacheManager.getPricing(service);
                    this.displayPricing(pricing);
                } catch (error) {
                    this.handleError('Failed to get pricing', error);
                }
            }

            displayPricing(pricing) {
                const currentPriceEl = document.getElementById('current-price');
                if (currentPriceEl) {
                    currentPriceEl.textContent = `N${pricing.base_price.toFixed(2)}`;
                }

                // Update tier badge
                const tierBadge = document.getElementById('tier-badge');
                if (tierBadge) {
                    tierBadge.textContent = pricing.tier_name || pricing.tier;
                    tierBadge.className = `tier-badge tier-${pricing.tier}`;
                    tierBadge.style.display = 'inline-block';
                }
            }

            async createVerification() {
                const service = document.getElementById('service-select').value;
                if (!service) {
                    this.showError('Please select a service');
                    return;
                }

                const createBtn = document.getElementById('create-verification-btn');
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.textContent = 'Creating...';
                }

                try {
                    const payload = {
                        service_name: service,
                        capability: 'sms'
                    };

                    // Add advanced options
                    const carrier = document.getElementById('carrier-select').value;
                    const areaCode = document.getElementById('area-code').value;
                    
                    if (carrier) payload.carrier = carrier;
                    if (areaCode) payload.area_code = areaCode;

                    this.lastAction = { type: 'create_verification', payload };

                    const token = localStorage.getItem('token');
                    const response = await fetch('/verify/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.detail || 'Verification creation failed');
                    }

                    this.showSuccess(`Verification created! Phone: ${result.phone_number}`);
                    this.loadActiveVerifications();
                    this.resetForm();

                } catch (error) {
                    this.handleError('Verification creation failed', error);
                } finally {
                    if (createBtn) {
                        createBtn.disabled = false;
                        createBtn.textContent = 'Create Verification';
                    }
                }
            }

            async loadActiveVerifications() {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('/verifications/active', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await response.json();
                    this.displayActiveVerifications(data.verifications);
                } catch (error) {
                    this.handleError('Failed to load verifications', error);
                }
            }

            displayActiveVerifications(verifications) {
                const container = document.getElementById('active-verifications');
                if (!container) return;

                if (verifications.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No active verifications</p>
                            <p class="text-muted">Create a verification to get started</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = verifications.map(verification => `
                    <div class="verification-item" data-id="${verification.id}">
                        <div class="verification-info">
                            <div class="verification-service">${this.formatServiceName(verification.service_name)}</div>
                            <div class="verification-phone">${verification.phone_number || 'Pending...'}</div>
                        </div>
                        <div class="verification-status status-${verification.status}">
                            ${verification.status}
                        </div>
                        <div class="verification-cost">N${verification.cost.toFixed(2)}</div>
                        <div class="verification-actions">
                            <button class="btn-secondary btn-sm" onclick="window.open('/verify/${verification.id}', '_blank')">
                                View
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            startHealthChecks() {
                this.healthCheckInterval = setInterval(() => {
                    this.checkSystemHealth();
                }, 30000);
                
                // Initial check
                this.checkSystemHealth();
            }

            async checkSystemHealth() {
                try {
                    const response = await fetch('/health');
                    const health = await response.json();
                    
                    this.updateHealthIndicator('api-health', response.ok);
                    this.updateHealthIndicator('api-status', response.ok);
                    
                } catch (error) {
                    this.updateHealthIndicator('api-health', false);
                    this.updateHealthIndicator('api-status', false);
                }
            }

            updateHealthIndicator(elementId, isHealthy) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.className = `status-dot ${isHealthy ? 'active' : 'inactive'}`;
                }
            }

            handleError(message, error) {
                console.error(message, error);
                this.showError(`${message}: ${error.message}`);
                
                // Log to error tracker
                if (window.errorTracker) {
                    window.errorTracker.logError({
                        type: 'application_error',
                        message: message,
                        details: error.message,
                        timestamp: Date.now()
                    });
                }
            }

            showError(message) {
                if (window.showNotification) {
                    window.showNotification(message, 'error');
                } else {
                    alert(message);
                }
            }

            showSuccess(message) {
                if (window.showNotification) {
                    window.showNotification(message, 'success');
                } else {
                    alert(message);
                }
            }

            retryLastAction() {
                if (this.lastAction) {
                    switch (this.lastAction.type) {
                        case 'create_verification':
                            this.createVerification();
                            break;
                        default:
                            this.showError('Cannot retry this action');
                    }
                }
            }

            // Utility methods
            formatServiceName(service) {
                return service.charAt(0).toUpperCase() + service.slice(1).replace(/[-_]/g, ' ');
            }

            formatCategoryName(category) {
                return category.charAt(0).toUpperCase() + category.slice(1).replace(/[-_]/g, ' ');
            }

            updateUserDisplay() {
                const creditsEl = document.getElementById('user-credits');
                if (creditsEl && this.user) {
                    creditsEl.textContent = `N${this.user.credits.toFixed(2)}`;
                }
            }

            resetForm() {
                const serviceSelect = document.getElementById('service-select');
                if (serviceSelect) serviceSelect.value = '';

                const carrierSelect = document.getElementById('carrier-select');
                if (carrierSelect) carrierSelect.value = '';

                const areaCodeInput = document.getElementById('area-code');
                if (areaCodeInput) areaCodeInput.value = '';

                this.clearPricing();
            }

            clearPricing() {
                const currentPriceEl = document.getElementById('current-price');
                if (currentPriceEl) currentPriceEl.textContent = 'N0.00';

                const tierBadge = document.getElementById('tier-badge');
                if (tierBadge) tierBadge.style.display = 'none';
            }

            logout() {
                localStorage.removeItem('token');
                window.location.href = '/login';
            }
        }

        // Global functions
        window.quickVerify = function(service) {
            const serviceSelect = document.getElementById('service-select');
            if (serviceSelect) {
                serviceSelect.value = service;
                serviceSelect.dispatchEvent(new Event('change'));
            }
        };

        window.showWalletModal = function() {
            document.getElementById('wallet-modal').style.display = 'flex';
        };

        window.showHistoryModal = function() {
            document.getElementById('history-modal').style.display = 'flex';
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        window.retryLastAction = function() {
            if (window.appController) {
                window.appController.retryLastAction();
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            window.appController = new EnhancedAppController();
        });
    </script>
</body>
</html>