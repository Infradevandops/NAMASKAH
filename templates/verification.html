<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Verification - Namaskah</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5; line-height: 1.6; color: #333;
        }
        .container { max-width: 800px; margin: 20px auto; padding: 0 20px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { padding: 20px; border-bottom: 1px solid #eee; }
        .card-body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        select, input, button { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; 
            font-size: 14px; font-family: inherit;
        }
        button { 
            background: #007bff; color: white; border: none; cursor: pointer; 
            font-weight: 500; transition: background 0.2s;
        }
        button:hover:not(:disabled) { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background: #545b62; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover:not(:disabled) { background: #c82333; }
        .alert { padding: 12px; border-radius: 4px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .verification-status { 
            display: flex; align-items: center; gap: 10px; padding: 15px; 
            background: #f8f9fa; border-radius: 4px; margin: 15px 0;
        }
        .status-indicator { 
            width: 12px; height: 12px; border-radius: 50%; 
            background: #6c757d; animation: pulse 2s infinite;
        }
        .status-indicator.active { background: #28a745; }
        .status-indicator.error { background: #dc3545; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .phone-display { 
            font-family: 'Courier New', monospace; font-size: 18px; 
            background: #f8f9fa; padding: 15px; border-radius: 4px; text-align: center;
        }
        .code-display { 
            font-family: 'Courier New', monospace; font-size: 24px; font-weight: bold;
            background: #e9ecef; padding: 20px; border-radius: 4px; text-align: center;
            letter-spacing: 2px; color: #28a745;
        }
        .service-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .service-card { 
            border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; cursor: pointer;
            transition: all 0.2s; text-align: center;
        }
        .service-card:hover { border-color: #007bff; }
        .service-card.selected { border-color: #007bff; background: #f8f9fa; }
        .service-icon { font-size: 24px; margin-bottom: 10px; }
        .progress-bar { 
            width: 100%; height: 4px; background: #e9ecef; border-radius: 2px; 
            overflow: hidden; margin: 10px 0;
        }
        .progress-fill { 
            height: 100%; background: #007bff; width: 0%; 
            transition: width 0.3s ease; border-radius: 2px;
        }
        .step-indicator { 
            display: flex; justify-content: space-between; margin-bottom: 20px;
            padding: 0 20px;
        }
        .step { 
            display: flex; flex-direction: column; align-items: center; 
            flex: 1; position: relative;
        }
        .step-number { 
            width: 30px; height: 30px; border-radius: 50%; 
            background: #e9ecef; color: #6c757d; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin-bottom: 5px;
        }
        .step.active .step-number { background: #007bff; color: white; }
        .step.completed .step-number { background: #28a745; color: white; }
        .step-label { font-size: 12px; text-align: center; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>SMS/Voice Verification Service</h2>
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-label">Select Service</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-label">Get Number</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-label">Verify Code</div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="alerts"></div>
                
                <!-- Step 1: Service Selection -->
                <div id="serviceSelection">
                    <div class="form-group">
                        <label>Select Verification Service:</label>
                        <div class="service-grid" id="serviceGrid">
                            <!-- Services loaded dynamically -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="country">Country:</label>
                        <select id="country">
                            <option value="US">United States</option>
                            <option value="UK">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Verification Type:</label>
                        <div style="display: flex; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; width: auto;">
                                <input type="radio" name="verifyType" value="sms" checked>
                                SMS Verification
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; width: auto;">
                                <input type="radio" name="verifyType" value="voice">
                                Voice Verification
                            </label>
                        </div>
                    </div>
                    
                    <button onclick="getNumber()" id="getNumberBtn">Get Phone Number</button>
                </div>
                
                <!-- Step 2: Phone Number Display -->
                <div id="numberDisplay" class="hidden">
                    <div class="verification-status">
                        <div class="status-indicator active"></div>
                        <span>Phone number ready for verification</span>
                    </div>
                    
                    <div class="form-group">
                        <label>Your Verification Phone Number:</label>
                        <div class="phone-display" id="phoneNumber">+1 (555) 123-4567</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Instructions:</strong>
                        <ol style="margin: 10px 0 0 20px;">
                            <li>Use this phone number in your app/service</li>
                            <li>Request verification code from the service</li>
                            <li>Wait for SMS/Voice call to arrive</li>
                            <li>The code will appear below automatically</li>
                        </ol>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="pollForCode()" id="pollBtn">Start Waiting for Code</button>
                        <button onclick="cancelNumber()" class="btn-danger">Cancel & Get New Number</button>
                    </div>
                </div>
                
                <!-- Step 3: Code Display -->
                <div id="codeDisplay" class="hidden">
                    <div class="verification-status">
                        <div class="status-indicator active"></div>
                        <span id="codeStatus">Waiting for verification code...</span>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    
                    <div class="form-group" id="codeResult" style="display: none;">
                        <label>Verification Code Received:</label>
                        <div class="code-display" id="verificationCode">123456</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="startNewVerification()" class="btn-secondary">New Verification</button>
                        <button onclick="cancelCurrentVerification()" class="btn-danger" id="cancelBtn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Account Balance -->
        <div class="card">
            <div class="card-header">
                <h3>Account Information</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>Balance:</strong> <span id="balance">Loading...</span>
                    </div>
                    <button onclick="refreshBalance()" class="btn-secondary" style="width: auto; padding: 5px 15px;">
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentVerification = null;
        let selectedService = null;
        let pollingInterval = null;
        
        // Load services on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadServices();
            loadBalance();
        });
        
        async function loadServices() {
            try {
                const response = await fetch('/verify/services');
                const data = await response.json();
                
                if (data.services) {
                    displayServices(data.services);
                } else {
                    showAlert('Failed to load services', 'error');
                }
            } catch (error) {
                showAlert('Error loading services: ' + error.message, 'error');
            }
        }
        
        function displayServices(services) {
            const grid = document.getElementById('serviceGrid');
            grid.innerHTML = '';
            
            services.forEach(service => {
                const card = document.createElement('div');
                card.className = 'service-card';
                card.onclick = () => selectService(service, card);
                
                card.innerHTML = `
                    <div class="service-icon">📱</div>
                    <div><strong>${service.name}</strong></div>
                    <div>$${service.price}</div>
                    ${service.voice_supported ? '<div style="font-size: 12px; color: #28a745;">Voice supported</div>' : ''}
                `;
                
                grid.appendChild(card);
            });
        }
        
        function selectService(service, element) {
            // Remove previous selection
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select current
            element.classList.add('selected');
            selectedService = service;
            
            // Enable/disable voice option based on service support
            const voiceRadio = document.querySelector('input[value="voice"]');
            const voiceLabel = voiceRadio.parentElement;
            
            if (service.voice_supported) {
                voiceRadio.disabled = false;
                voiceLabel.style.opacity = '1';
            } else {
                voiceRadio.disabled = true;
                voiceLabel.style.opacity = '0.5';
                document.querySelector('input[value="sms"]').checked = true;
            }
        }
        
        async function getNumber() {
            if (!selectedService) {
                showAlert('Please select a service first', 'error');
                return;
            }
            
            const country = document.getElementById('country').value;
            const isVoice = document.querySelector('input[name="verifyType"]:checked').value === 'voice';
            
            document.getElementById('getNumberBtn').disabled = true;
            document.getElementById('getNumberBtn').textContent = 'Getting number...';
            
            try {
                const response = await fetch('/verify/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({
                        service_name: selectedService.name,
                        country: country,
                        capability: isVoice ? 'voice' : 'sms'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentVerification = data;
                    showNumberStep(data.phone_number);
                    updateStep(2);
                } else {
                    showAlert(data.detail || 'Failed to get number', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            } finally {
                document.getElementById('getNumberBtn').disabled = false;
                document.getElementById('getNumberBtn').textContent = 'Get Phone Number';
            }
        }
        
        function showNumberStep(phoneNumber) {
            document.getElementById('serviceSelection').classList.add('hidden');
            document.getElementById('numberDisplay').classList.remove('hidden');
            document.getElementById('phoneNumber').textContent = phoneNumber;
        }
        
        async function pollForCode() {
            if (!currentVerification) return;
            
            document.getElementById('numberDisplay').classList.add('hidden');
            document.getElementById('codeDisplay').classList.remove('hidden');
            updateStep(3);
            
            const isVoice = document.querySelector('input[name="verifyType"]:checked').value === 'voice';
            let attempts = 0;
            const maxAttempts = 30;
            
            document.getElementById('codeStatus').textContent = 
                `Waiting for ${isVoice ? 'voice call' : 'SMS'}... (${attempts}/${maxAttempts})`;
            
            pollingInterval = setInterval(async () => {
                attempts++;
                
                // Update progress
                const progress = (attempts / maxAttempts) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('codeStatus').textContent = 
                    `Waiting for ${isVoice ? 'voice call' : 'SMS'}... (${attempts}/${maxAttempts})`;
                
                try {
                    const endpoint = isVoice ? 
                        `/verify/${currentVerification.id}/voice` : 
                        `/verify/${currentVerification.id}/messages`;
                        
                    const response = await fetch(endpoint);
                    const data = await response.json();
                    
                    if (data.messages && data.messages.length > 0) {
                        clearInterval(pollingInterval);
                        showVerificationCode(data.messages[0]);
                        updateStep(3, true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(pollingInterval);
                        showAlert('Timeout waiting for verification code', 'error');
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }
        
        function showVerificationCode(message) {
            document.getElementById('codeResult').style.display = 'block';
            document.getElementById('verificationCode').textContent = message;
            document.getElementById('codeStatus').textContent = 'Verification code received!';
            document.querySelector('#codeDisplay .status-indicator').classList.add('active');
            
            showAlert('Verification code received successfully!', 'success');
        }
        
        async function cancelNumber() {
            if (!currentVerification) return;
            
            try {
                const response = await fetch(`/verify/${currentVerification.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                if (response.ok) {
                    showAlert('Number cancelled successfully', 'success');
                    startNewVerification();
                } else {
                    showAlert('Failed to cancel number', 'error');
                }
            } catch (error) {
                showAlert('Error cancelling number: ' + error.message, 'error');
            }
        }
        
        function cancelCurrentVerification() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            cancelNumber();
        }
        
        function startNewVerification() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            currentVerification = null;
            selectedService = null;
            
            // Reset UI
            document.getElementById('serviceSelection').classList.remove('hidden');
            document.getElementById('numberDisplay').classList.add('hidden');
            document.getElementById('codeDisplay').classList.add('hidden');
            document.getElementById('codeResult').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
            
            // Reset service selection
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            updateStep(1);
            loadBalance(); // Refresh balance
        }
        
        async function loadBalance() {
            try {
                const response = await fetch('/wallet/balance', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('balance').textContent = 
                        `$${data.credits_usd.toFixed(2)} (${data.credits.toFixed(1)} credits)`;
                } else {
                    document.getElementById('balance').textContent = 'Error loading balance';
                }
            } catch (error) {
                document.getElementById('balance').textContent = 'Error loading balance';
            }
        }
        
        function refreshBalance() {
            document.getElementById('balance').textContent = 'Loading...';
            loadBalance();
        }
        
        function updateStep(stepNumber, completed = false) {
            // Reset all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // Mark completed steps
            for (let i = 1; i < stepNumber; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }
            
            // Mark current step
            if (completed) {
                document.getElementById(`step${stepNumber}`).classList.add('completed');
            } else {
                document.getElementById(`step${stepNumber}`).classList.add('active');
            }
        }
        
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            alertsContainer.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Check if user is logged in
        if (!localStorage.getItem('token')) {
            showAlert('Please log in to use verification services', 'error');
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 2000);
        }
    </script>
</body>
</html>