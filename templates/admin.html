<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Namaskah SMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/mobile.css">
    <script src="/track.js"></script>
    <script src="/static/js/home-button.js" defer></script>
    <style>
        * { box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: #1e293b;
        }
        .container {
            background: #f1f5f9;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            padding: 35px;
            max-width: 1400px;
            margin: 30px auto;
        }
        header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        header h1 {
            color: #0f172a;
            margin: 0 0 8px 0;
            font-size: 32px;
            font-weight: 700;
        }
        header p {
            color: #64748b;
            margin: 0;
            font-size: 15px;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        .card h2 {
            color: #0f172a;
            font-size: 22px;
            margin: 0 0 24px 0;
            font-weight: 700;
        }
        .verification-item {
            background: #f8fafc;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 14px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        .verification-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        button, .btn-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 11px 22px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        button:hover, .btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        .btn-danger:hover {
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], select, textarea {
            background: white;
            border: 2px solid #e2e8f0;
            padding: 11px 16px;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
            color: #0f172a;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: #fafbfc;
        }
        .user-info {
            background: white;
            padding: 18px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        .user-info span {
            color: #0f172a;
            font-weight: 600;
            font-size: 15px;
        }
        code {
            background: #f1f5f9;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            border: 1px solid #e2e8f0;
        }
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 18px 28px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: 600;
            font-size: 15px;
        }
        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .hidden { display: none !important; }
        strong { font-weight: 600; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; margin: 10px; border-radius: 12px; }
            header { padding: 20px; }
            header h1 { font-size: 24px; }
            .card { padding: 18px; }
            .card h2 { font-size: 18px; }
            #stats { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            #stats > div { padding: 18px; }
            #stats > div > div:first-child { font-size: 28px; }
            .verification-item { padding: 14px; flex-direction: column; align-items: flex-start !important; gap: 12px; }
            .verification-item > div:last-child { width: 100%; display: flex; gap: 8px; }
            .verification-item button { flex: 1; }
            input[type="text"], input[type="email"], input[type="password"], input[type="number"], select {
                width: 100% !important;
                font-size: 16px;
            }
            button, .btn-small { min-height: 44px; font-size: 15px; }
            .user-info { flex-direction: column; gap: 12px; align-items: flex-start; }
            .notification { top: 10px; right: 10px; left: 10px; }
            code { font-size: 11px; padding: 3px 6px; }
        }
        
        @media (max-width: 480px) {
            #stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Admin Panel</h1>
            <p>Manage platform users, statistics, funding, and support</p>
        </header>

        <div id="auth-section">
            <div class="card">
                <h2>Admin Login</h2>
                <input type="email" id="admin-email" placeholder="Admin Email" required>
                <input type="password" id="admin-password" placeholder="Password" required>
                <button onclick="adminLogin()">Login</button>
            </div>
        </div>

        <div id="admin-section" class="hidden">
            <div class="user-info">
                <span id="admin-email-display"></span>
                <button onclick="logout()">Logout</button>
            </div>

            <div class="card">
                <h2>Growth Dashboard</h2>
                <div id="growth-dashboard" style="margin-bottom: 30px;"></div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="margin: 0;">Statistics</h2>
                    <select id="period-select" onchange="loadStats()">
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div id="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; margin-bottom: 24px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 14px; box-shadow: 0 6px 16px rgba(102, 126, 234, 0.35);">
                        <div style="font-size: 36px; font-weight: 700;" id="total-users">0</div>
                        <div style="opacity: 0.95; font-size: 14px; margin-top: 6px; font-weight: 500;">Total Users</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 24px; border-radius: 14px; box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);">
                        <div style="font-size: 36px; font-weight: 700;" id="new-users">0</div>
                        <div style="opacity: 0.95; font-size: 14px; margin-top: 6px; font-weight: 500;">New Users</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 24px; border-radius: 14px; box-shadow: 0 6px 16px rgba(245, 158, 11, 0.35);">
                        <div style="font-size: 36px; font-weight: 700;" id="total-verifications">0</div>
                        <div style="opacity: 0.95; font-size: 14px; margin-top: 6px; font-weight: 500;">Verifications</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 24px; border-radius: 14px; box-shadow: 0 6px 16px rgba(139, 92, 246, 0.35);">
                        <div style="font-size: 36px; font-weight: 700;" id="total-revenue">$0</div>
                        <div style="opacity: 0.95; font-size: 14px; margin-top: 6px; font-weight: 500;">Revenue</div>
                    </div>
                </div>
                
                <div style="background: #f8fafc; padding: 22px; border-radius: 14px; border: 1px solid #e2e8f0; margin-bottom: 24px;">
                    <h3 style="margin: 0 0 18px 0; color: #0f172a; font-size: 18px; font-weight: 700;">Most Used Services</h3>
                    <div id="popular-services"></div>
                </div>
                
                <div style="background: #f8fafc; padding: 22px; border-radius: 14px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 18px 0; color: #0f172a; font-size: 18px; font-weight: 700;">Verification Success Report</h3>
                    <div id="verification-report"></div>
                </div>
            </div>

            <div class="card">
                <h2>User Account Management</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <button onclick="showUserSection('list')" class="btn-small">User List</button>
                    <button onclick="showUserSection('suspend')" class="btn-small" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">Suspend/Activate</button>
                    <button onclick="showUserSection('delete')" class="btn-small" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">Delete Users</button>
                </div>
                <div id="user-management-section"></div>
            </div>

            <div class="card">
                <h2>Verification Management</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="loadActiveVerifications()" class="btn-small">Active Verifications</button>
                    <button onclick="loadFailedVerifications()" class="btn-small" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">Failed</button>
                </div>
                <div id="verifications-management"></div>
            </div>

            <div class="card">
                <h2>Service Pricing Management</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="loadServicePricing()" class="btn-small">View Pricing</button>
                    <button onclick="showSetPricing()" class="btn-small" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Set Price</button>
                    <button onclick="showBulkPricing()" class="btn-small" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">Bulk Update</button>
                </div>
                <div id="pricing-management"></div>
            </div>

            <div class="card">
                <h2>Rental Management</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="loadActiveRentals()" class="btn-small">Active Rentals</button>
                    <button onclick="loadExpiringSoon()" class="btn-small" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">Expiring Soon</button>
                </div>
                <div id="rentals-management"></div>
            </div>

            <div class="card">
                <h2>System Configuration</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button onclick="loadSystemConfig()" class="btn-small">View Config</button>
                    <button onclick="showSetConfig()" class="btn-small" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Set Config</button>
                </div>
                <div id="system-config"></div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
                    <h2 style="margin: 0;">All Users</h2>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="balance-filter" onchange="filterUsers()">
                            <option value="all">All Balances</option>
                            <option value="high">High (>N10)</option>
                            <option value="medium">Medium (N2-N10)</option>
                            <option value="low">Low (<N2)</option>
                            <option value="zero">Zero</option>
                        </select>
                        <select id="sort-order" onchange="filterUsers()">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="balance-high">Highest Balance</option>
                            <option value="balance-low">Lowest Balance</option>
                        </select>
                        <input type="text" id="user-search" placeholder="Search email..." oninput="filterUsers()" style="width: 200px;">
                        <button onclick="loadUsers()" class="btn-small">Refresh</button>
                        <button onclick="exportUsers()" class="btn-small" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">Export CSV</button>
                    </div>
                </div>
                <div id="users-list"></div>
                <div id="pagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;"></div>
            </div>

            <div class="card">
                <h2>Funding Attempts</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
                    <select id="funding-status-filter" onchange="loadFundingAttempts()">
                        <option value="all">All Status</option>
                        <option value="completed">Successful</option>
                        <option value="initialized">Pending</option>
                        <option value="failed">Failed</option>
                    </select>
                    <input type="text" id="funding-search" placeholder="Search email or reference..." oninput="loadFundingAttempts()" style="width: 280px;">
                    <button onclick="loadFundingAttempts()" class="btn-small">Refresh</button>
                </div>
                <div id="funding-list"></div>
            </div>

            <div class="card">
                <h2>Support Tickets</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="loadTickets('open')" class="btn-small">Open</button>
                    <button onclick="loadTickets('resolved')" class="btn-small">Resolved</button>
                    <button onclick="loadTickets()" class="btn-small">All</button>
                </div>
                <div id="tickets-list"></div>
            </div>

            <div id="ticket-modal" class="card hidden">
                <h2>Respond to Ticket</h2>
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div><strong>From:</strong> <span id="ticket-email"></span></div>
                    <div><strong>Category:</strong> <span id="ticket-category"></span></div>
                    <div style="margin-top: 10px;"><strong>Message:</strong></div>
                    <div id="ticket-message" style="margin-top: 5px; color: #6b7280;"></div>
                </div>
                <textarea id="ticket-response" rows="5" placeholder="Your response..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="respondToTicket()">Send Response</button>
                    <button onclick="closeTicketModal()" class="btn-danger">Cancel</button>
                </div>
            </div>

            <div id="add-credits-modal" class="card hidden">
                <h2>Add Credits</h2>
                <div style="background: #f9fafb; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                    <strong>User:</strong><br>
                    <span id="selected-user-email"></span>
                </div>
                <input type="number" id="credits-amount" placeholder="Amount (N)" step="0.50" min="0.50">
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="addCredits()">Add Credits</button>
                    <button onclick="closeModal()" class="btn-danger">Cancel</button>
                </div>
            </div>
        </div>

        <div id="notification" class="notification hidden"></div>
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let token = localStorage.getItem('admin_token');
        let selectedUserId = null;

        if (token) {
            checkAuth();
        }

        async function adminLogin() {
            let email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            
            // Strip mailto: prefix if present
            email = email.replace(/^mailto:/i, '');
            
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                
                const data = await res.json();
                
                if (res.ok && data.is_admin) {
                    token = data.token;
                    localStorage.setItem('admin_token', token);
                    showNotification('Admin login successful!', 'success');
                    showAdmin();
                } else if (res.ok && !data.is_admin) {
                    showNotification('Not an admin account', 'error');
                } else {
                    showNotification(data.detail || 'Login failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE}/auth/me`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                
                if (res.ok) {
                    const user = await res.json();
                    if (user.is_admin) {
                        document.getElementById('admin-email-display').textContent = user.email;
                        showAdmin();
                    } else {
                        logout();
                    }
                } else {
                    logout();
                }
            } catch (err) {
                logout();
            }
        }

        function showAdmin() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('admin-section').classList.remove('hidden');
            loadGrowthDashboard();
            loadStats();
            loadUsers();
            loadFundingAttempts();
            loadTickets();
        }

        async function loadGrowthDashboard() {
            try {
                const [statsRes, affiliateRes, subsRes] = await Promise.all([
                    fetch(`${API_BASE}/admin/stats?period=all`, {
                        headers: {'Authorization': `Bearer ${token}`}
                    }),
                    fetch(`${API_BASE}/admin/affiliates/stats`, {
                        headers: {'Authorization': `Bearer ${token}`}
                    }),
                    fetch(`${API_BASE}/admin/subscriptions/stats`, {
                        headers: {'Authorization': `Bearer ${token}`}
                    })
                ]);
                
                const stats = await statsRes.json();
                const affiliate = await affiliateRes.json();
                const subs = await subsRes.json();
                
                const TARGET = 500;
                const current = stats.total_users || 0;
                const remaining = Math.max(0, TARGET - current);
                const progress = Math.min(100, (current / TARGET) * 100);
                
                // Subscription metrics
                const totalUsers = current;
                const subscribedUsers = (subs.developer || 0) + (subs.enterprise || 0);
                const nonSubscribed = totalUsers - subscribedUsers;
                const subscriptionRate = totalUsers > 0 ? ((subscribedUsers / totalUsers) * 100).toFixed(1) : 0;
                
                // Calculate projections
                const avgGrowth = stats.new_users || 10; // per month
                const monthsToTarget = remaining > 0 ? Math.ceil(remaining / avgGrowth) : 0;
                
                // Affiliate ROI
                const affiliateRevenue = affiliate.total_referrals * 15; // avg N15 per user
                const affiliateCost = affiliate.total_commissions_paid || 0;
                const affiliateROI = affiliateCost > 0 ? ((affiliateRevenue - affiliateCost) / affiliateCost * 100).toFixed(0) : 0;
                
                document.getElementById('growth-dashboard').innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 16px; color: white; margin-bottom: 20px; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h3 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">User Acquisition Target</h3>
                                <p style="margin: 0; opacity: 0.9; font-size: 15px;">Track progress towards ${TARGET} users goal</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 48px; font-weight: 700; line-height: 1;">${current}</div>
                                <div style="opacity: 0.9; font-size: 14px; margin-top: 4px;">of ${TARGET} users</div>
                            </div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); height: 24px; border-radius: 12px; overflow: hidden; margin-bottom: 12px;">
                            <div style="background: linear-gradient(90deg, #10b981 0%, #059669 100%); height: 100%; width: ${progress}%; transition: width 1s ease; box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 14px; opacity: 0.95;">
                            <span>${progress.toFixed(1)}% Complete</span>
                            <span>${remaining} users remaining</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div style="background: white; padding: 24px; border-radius: 14px; border: 2px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #667eea;">${avgGrowth}</div>
                            <div style="color: #64748b; font-size: 13px; margin-top: 8px; font-weight: 600;">Avg Growth/Month</div>
                        </div>
                        <div style="background: white; padding: 24px; border-radius: 14px; border: 2px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #10b981;">${monthsToTarget}</div>
                            <div style="color: #64748b; font-size: 13px; margin-top: 8px; font-weight: 600;">Months to Target</div>
                        </div>
                        <div style="background: white; padding: 24px; border-radius: 14px; border: 2px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #f59e0b;">${affiliate.active_affiliates || 0}</div>
                            <div style="color: #64748b; font-size: 13px; margin-top: 8px; font-weight: 600;">Active Affiliates</div>
                        </div>
                        <div style="background: white; padding: 24px; border-radius: 14px; border: 2px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #8b5cf6;">${affiliateROI}%</div>
                            <div style="color: #64748b; font-size: 13px; margin-top: 8px; font-weight: 600;">Affiliate ROI</div>
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 24px; border-radius: 14px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 16px 0; color: #0f172a; font-size: 18px; font-weight: 700;">Subscription Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e2e8f0;">
                                <div style="font-size: 32px; font-weight: 700; color: #667eea;">${totalUsers}</div>
                                <div style="color: #64748b; font-size: 13px; margin-top: 6px; font-weight: 600;">Total Users</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #10b981;">
                                <div style="font-size: 32px; font-weight: 700; color: #10b981;">${subscribedUsers}</div>
                                <div style="color: #64748b; font-size: 13px; margin-top: 6px; font-weight: 600;">Subscribed</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #ef4444;">
                                <div style="font-size: 32px; font-weight: 700; color: #ef4444;">${nonSubscribed}</div>
                                <div style="color: #64748b; font-size: 13px; margin-top: 6px; font-weight: 600;">Free Tier</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #8b5cf6;">
                                <div style="font-size: 32px; font-weight: 700; color: #8b5cf6;">${subscriptionRate}%</div>
                                <div style="color: #64748b; font-size: 13px; margin-top: 6px; font-weight: 600;">Conversion</div>
                            </div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-size: 14px; font-weight: 600; color: #0f172a;">Subscription Breakdown</span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 10px;">
                                    <div style="font-size: 24px; font-weight: 700; color: #94a3b8;">${subs.pay_as_you_go || 0}</div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Pay-as-You-Go</div>
                                    <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;">No discount</div>
                                </div>
                                <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, #f59e0b15 0%, #d9770615 100%); border-radius: 10px; border: 2px solid #f59e0b;">
                                    <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">${subs.developer || 0}</div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Developer</div>
                                    <div style="font-size: 11px; color: #f59e0b; margin-top: 2px; font-weight: 600;">20% off</div>
                                </div>
                                <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, #8b5cf615 0%, #7c3aed15 100%); border-radius: 10px; border: 2px solid #8b5cf6;">
                                    <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;">${subs.enterprise || 0}</div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Enterprise</div>
                                    <div style="font-size: 11px; color: #8b5cf6; margin-top: 2px; font-weight: 600;">35% off</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 24px; border-radius: 14px; border: 1px solid #e2e8f0;">
                        <h3 style="margin: 0 0 16px 0; color: #0f172a; font-size: 18px; font-weight: 700;">Affiliate Program Performance</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 6px;">Total Affiliates</div>
                                <div style="font-size: 28px; font-weight: 700; color: #0f172a;">${affiliate.total_affiliates || 0}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 6px;">Total Referrals</div>
                                <div style="font-size: 28px; font-weight: 700; color: #0f172a;">${affiliate.total_referrals || 0}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 6px;">Commissions Paid</div>
                                <div style="font-size: 28px; font-weight: 700; color: #ef4444;">N${(affiliate.total_commissions_paid || 0).toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 13px; margin-bottom: 6px;">Revenue Generated</div>
                                <div style="font-size: 28px; font-weight: 700; color: #10b981;">N${affiliateRevenue.toFixed(2)}</div>
                            </div>
                        </div>
                        ${affiliate.top_affiliates && affiliate.top_affiliates.length > 0 ? `
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                                <h4 style="margin: 0 0 12px 0; color: #0f172a; font-size: 15px; font-weight: 700;">Top Affiliates</h4>
                                ${affiliate.top_affiliates.slice(0, 5).map((a, i) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <span style="font-weight: 700; color: #667eea; min-width: 24px;">#${i + 1}</span>
                                            <span style="font-size: 14px; color: #0f172a;">${a.email}</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <span style="font-size: 13px; color: #64748b;">${a.referral_count} refs</span>
                                            <span style="font-weight: 700; color: #10b981;">N${a.earnings.toFixed(2)}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load growth dashboard:', err);
                document.getElementById('growth-dashboard').innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load dashboard</p>';
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('admin_token');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('admin-section').classList.add('hidden');
        }

        async function loadStats() {
            try {
                const period = document.getElementById('period-select').value;
                const res = await fetch(`${API_BASE}/admin/stats?period=${period}`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('total-users').textContent = data.total_users;
                    document.getElementById('new-users').textContent = data.new_users || 0;
                    document.getElementById('total-verifications').textContent = data.total_verifications;
                    document.getElementById('total-revenue').textContent = `$${data.total_revenue.toFixed(2)}`;
                    
                    // Popular services
                    const servicesList = document.getElementById('popular-services');
                    if (data.popular_services && data.popular_services.length > 0) {
                        servicesList.innerHTML = data.popular_services.map((s, i) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-radius: 10px; margin-bottom: 12px; border: 1px solid #e2e8f0; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <div style="display: flex; align-items: center; gap: 14px;">
                                    <span style="font-weight: 700; color: #667eea; min-width: 35px; font-size: 17px;">#${i + 1}</span>
                                    <strong style="text-transform: capitalize; color: #0f172a; font-size: 15px;">${s.service}</strong>
                                </div>
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 7px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">${s.count} uses</span>
                                    <span style="color: #10b981; font-weight: 700; font-size: 16px;">$${s.revenue.toFixed(2)}</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        servicesList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px; font-size: 14px;">No services data available for this period</p>';
                    }
                    
                    // Verification report
                    const reportDiv = document.getElementById('verification-report');
                    const completed = data.completed_verifications || 0;
                    const cancelled = data.cancelled_verifications || 0;
                    const pending = data.pending_verifications || 0;
                    const successRate = data.success_rate || 0;
                    
                    reportDiv.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e2e8f0; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.25)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <div style="font-size: 32px; font-weight: 700; color: #10b981;">${completed}</div>
                                <div style="color: #64748b; font-size: 13px; margin-top: 8px; font-weight: 600;">Successful</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e2e8f0; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.borderColor='#ef4444'; this.style.boxShadow='0 6px 16px rgba(239, 68, 68, 0.25)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <div style="font-size: 32px; font-weight: 700; color: #ef4444;">${cancelled}</div>
                                <div style="color: #64748b; font-size: 13px; margin-top: 8px; font-weight: 600;">Failed/Cancelled</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e2e8f0; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 6px 16px rgba(245, 158, 11, 0.25)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <div style="font-size: 32px; font-weight: 700; color: #f59e0b;">${pending}</div>
                                <div style="color: #64748b; font-size: 13px; margin-top: 8px; font-weight: 600;">Pending</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #e2e8f0; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.25)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                <div style="font-size: 32px; font-weight: 700; color: #667eea;">${successRate}%</div>
                                <div style="color: #64748b; font-size: 13px; margin-top: 8px; font-weight: 600;">Success Rate</div>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                showNotification('Failed to load stats', 'error');
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_BASE}/admin/users`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                
                if (res.ok) {
                    const data = await res.json();
                    allUsers = data.users;
                    filterUsers();
                    /*
                    const list = document.getElementById('users-list');
                    list.innerHTML = data.users.map(u => `
                        <div class="verification-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${u.email}</strong>
                                <div style="font-size: 14px; color: #6b7280;">
                                    Credits: $${u.credits.toFixed(2)} ${u.is_admin ? '| Admin' : ''}
                                </div>
                                <div style="font-size: 12px; color: #9ca3af;">
                                    Joined: ${new Date(u.created_at).toLocaleDateString()}
                                </div>
                            </div>
                            <button onclick="openAddCredits('${u.id}', '${u.email}')" class="btn-small">
                                Add Credits
                            </button>
                        </div>
                    `).join('');*/
                    
                    showNotification('Users loaded', 'success');
                }
            } catch (err) {
                showNotification('Failed to load users', 'error');
            }
        }

        function openAddCredits(userId, email) {
            selectedUserId = userId;
            document.getElementById('selected-user-email').innerHTML = `${email}<br><small style="color: #6b7280;">User ID: ${userId}</small>`;
            document.getElementById('add-credits-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('add-credits-modal').classList.add('hidden');
            selectedUserId = null;
        }

        async function addCredits() {
            const amount = parseFloat(document.getElementById('credits-amount').value);
            
            if (!amount || amount <= 0) {
                showNotification('Invalid amount', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/credits/add`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({user_id: selectedUserId, amount})
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showNotification(data.message, 'success');
                    closeModal();
                    loadUsers();
                    loadStats();
                } else {
                    showNotification('Failed to add credits', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        let allUsers = [];
        let currentTicketId = null;

        function filterUsers() {
            const query = document.getElementById('user-search').value.toLowerCase();
            const balanceFilter = document.getElementById('balance-filter').value;
            const sortOrder = document.getElementById('sort-order').value;
            
            let filtered = allUsers.filter(u => u.email.toLowerCase().includes(query));
            
            // Balance filter
            if (balanceFilter === 'high') {
                filtered = filtered.filter(u => u.credits > 10);
            } else if (balanceFilter === 'medium') {
                filtered = filtered.filter(u => u.credits >= 2 && u.credits <= 10);
            } else if (balanceFilter === 'low') {
                filtered = filtered.filter(u => u.credits > 0 && u.credits < 2);
            } else if (balanceFilter === 'zero') {
                filtered = filtered.filter(u => u.credits === 0);
            }
            
            // Sort
            if (sortOrder === 'newest') {
                filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else if (sortOrder === 'oldest') {
                filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            } else if (sortOrder === 'balance-high') {
                filtered.sort((a, b) => b.credits - a.credits);
            } else if (sortOrder === 'balance-low') {
                filtered.sort((a, b) => a.credits - b.credits);
            }
            
            renderUsers(filtered);
        }

        function renderUsers(users) {
            const list = document.getElementById('users-list');
            if (users.length === 0) {
                list.innerHTML = '<p style="color: #64748b; text-align: center; padding: 40px;">No users found</p>';
                return;
            }
            list.innerHTML = users.map(u => {
                const balanceColor = u.credits > 10 ? '#10b981' : u.credits > 2 ? '#f59e0b' : u.credits > 0 ? '#ef4444' : '#94a3b8';
                return `
                    <div class="verification-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                <strong style="font-size: 16px; color: #0f172a;">${u.email}</strong>
                                ${u.is_admin ? '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">ADMIN</span>' : ''}
                            </div>
                            <div style="font-size: 14px; color: #475569; margin-bottom: 5px;">
                                Balance: <strong style="color: ${balanceColor}; font-size: 15px;">N${u.credits.toFixed(2)}</strong> | 
                                Free: <strong>${u.free_verifications || 0}</strong>
                            </div>
                            <div style="font-size: 12px; color: #94a3b8;">
                                ID: <code>${u.id}</code> | 
                                Joined: ${new Date(u.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                            <button onclick="viewUserDetails('${u.id}')" class="btn-small" style="padding: 9px 18px;">View</button>
                            <button onclick="openAddCredits('${u.id}', '${u.email}')" class="btn-small" style="padding: 9px 18px;">Add Credits</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewUserDetails(userId) {
            try {
                const res = await fetch(`${API_BASE}/admin/users/${userId}`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                if (res.ok) {
                    const data = await res.json();
                    alert(`User: ${data.user.email}\nCredits: $${data.user.credits}\nTotal Verifications: ${data.stats.total_verifications}\nTotal Spent: $${data.stats.total_spent}`);
                }
            } catch (err) {
                showNotification('Failed to load user details', 'error');
            }
        }

        async function exportUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/export/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    showNotification('Export failed: Not authenticated', 'error');
                    return;
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showNotification('Users exported successfully!', 'success');
            } catch (error) {
                showNotification('Failed to export users', 'error');
            }
        }

        async function loadFundingAttempts() {
            try {
                const statusFilter = document.getElementById('funding-status-filter').value;
                const search = document.getElementById('funding-search').value;
                
                let url = `${API_BASE}/admin/payment-logs?`;
                if (search) url += `email=${encodeURIComponent(search)}&`;
                
                const res = await fetch(url, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                
                if (res.ok) {
                    const data = await res.json();
                    let logs = data.logs;
                    
                    // Filter by status
                    if (statusFilter !== 'all') {
                        logs = logs.filter(l => l.status === statusFilter);
                    }
                    
                    // Filter by search
                    if (search) {
                        logs = logs.filter(l => 
                            (l.email && l.email.toLowerCase().includes(search.toLowerCase())) ||
                            (l.reference && l.reference.toLowerCase().includes(search.toLowerCase()))
                        );
                    }
                    
                    const list = document.getElementById('funding-list');
                    if (logs.length === 0) {
                        list.innerHTML = '<p style="color: #6b7280; text-align: center;">No funding attempts found</p>';
                    } else {
                        list.innerHTML = logs.map(l => {
                            const statusColor = l.status === 'completed' ? '#10b981' : l.status === 'failed' ? '#ef4444' : '#f59e0b';
                            const statusBg = l.status === 'completed' ? '#d1fae5' : l.status === 'failed' ? '#fee2e2' : '#fef3c7';
                            return `
                                <div class="verification-item" style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                            <strong style="font-size: 15px;">${l.email || 'Unknown'}</strong>
                                            <span style="background: ${statusBg}; color: ${statusColor}; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">${l.status.toUpperCase()}</span>
                                        </div>
                                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 3px;">
                                            Amount: <strong>N${(l.namaskah_amount || 0).toFixed(2)}</strong> (${(l.amount_ngn || 0).toFixed(2)}) | 
                                            Webhook: ${l.webhook_received ? '' : ''} | Credited: ${l.credited ? '' : ''}
                                        </div>
                                        <div style="font-size: 12px; color: #9ca3af;">
                                            Reference: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">${l.reference}</code> | 
                                            ${new Date(l.created_at).toLocaleString()}
                                        </div>
                                        ${l.error_message ? `<div style="font-size: 12px; color: #ef4444; margin-top: 3px;">Error: ${l.error_message}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (err) {
                showNotification('Failed to load funding attempts', 'error');
            }
        }

        async function loadTickets(status = null) {
            try {
                const url = status ? `${API_BASE}/admin/support/tickets?status=${status}` : `${API_BASE}/admin/support/tickets`;
                const res = await fetch(url, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                if (res.ok) {
                    const data = await res.json();
                    const list = document.getElementById('tickets-list');
                    if (data.tickets.length === 0) {
                        list.innerHTML = '<p style="color: #6b7280; text-align: center;">No tickets found</p>';
                    } else {
                        list.innerHTML = data.tickets.map(t => `
                            <div class="verification-item" style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${t.name}</strong> (${t.email})
                                    <div style="font-size: 14px; color: #6b7280;">
                                        ${t.category} | ${t.status}
                                    </div>
                                    <div style="font-size: 12px; color: #9ca3af;">
                                        ${new Date(t.created_at).toLocaleString()}
                                    </div>
                                </div>
                                <button onclick="openTicketModal('${t.id}', '${t.name}', '${t.email}', '${t.category}', '${t.message.replace(/'/g, "\\'")}')">Respond</button>
                            </div>
                        `).join('');
                    }
                }
            } catch (err) {
                showNotification('Failed to load tickets', 'error');
            }
        }

        function openTicketModal(id, name, email, category, message) {
            currentTicketId = id;
            document.getElementById('ticket-email').textContent = `${name} (${email})`;
            document.getElementById('ticket-category').textContent = category;
            document.getElementById('ticket-message').textContent = message;
            document.getElementById('ticket-modal').classList.remove('hidden');
        }

        function closeTicketModal() {
            document.getElementById('ticket-modal').classList.add('hidden');
            currentTicketId = null;
        }

        async function respondToTicket() {
            const response = document.getElementById('ticket-response').value;
            if (!response) {
                showNotification('Please enter a response', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/admin/support/${currentTicketId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({response})
                });
                if (res.ok) {
                    showNotification('Response sent!', 'success');
                    closeTicketModal();
                    loadTickets();
                }
            } catch (err) {
                showNotification('Failed to send response', 'error');
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // User Management Functions
        function showUserSection(section) {
            const container = document.getElementById('user-management-section');
            if (section === 'list') {
                container.innerHTML = '<p style="color: #64748b;">Use the "All Users" section below for full user list</p>';
            } else if (section === 'suspend') {
                container.innerHTML = `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                        <h3 style="margin: 0 0 15px 0;">Suspend/Activate User</h3>
                        <input type="text" id="suspend-user-id" placeholder="User ID" style="width: 100%; margin-bottom: 10px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="suspendUser()" class="btn-danger">Suspend</button>
                            <button onclick="activateUser()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Activate</button>
                        </div>
                    </div>
                `;
            } else if (section === 'delete') {
                container.innerHTML = `
                    <div style="background: #fee2e2; padding: 20px; border-radius: 12px; border: 2px solid #ef4444;">
                        <h3 style="margin: 0 0 10px 0; color: #ef4444;"> Delete User (Permanent)</h3>
                        <p style="color: #991b1b; margin-bottom: 15px;">This action cannot be undone. All user data will be permanently deleted.</p>
                        <input type="text" id="delete-user-id" placeholder="User ID" style="width: 100%; margin-bottom: 10px;">
                        <button onclick="deleteUser()" class="btn-danger">Delete Permanently</button>
                    </div>
                `;
            }
        }

        async function suspendUser() {
            const userId = document.getElementById('suspend-user-id').value;
            if (!userId) return showNotification('Enter user ID', 'error');
            
            try {
                const res = await fetch(`${API_BASE}/admin/users/${userId}/suspend`, {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(data.message, 'success');
                    loadUsers();
                } else {
                    showNotification(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        async function activateUser() {
            const userId = document.getElementById('suspend-user-id').value;
            if (!userId) return showNotification('Enter user ID', 'error');
            
            try {
                const res = await fetch(`${API_BASE}/admin/users/${userId}/activate`, {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(data.message, 'success');
                    loadUsers();
                } else {
                    showNotification(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        async function deleteUser() {
            const userId = document.getElementById('delete-user-id').value;
            if (!userId) return showNotification('Enter user ID', 'error');
            
            if (!confirm('Are you ABSOLUTELY sure? This will permanently delete all user data!')) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(data.message, 'success');
                    loadUsers();
                    loadStats();
                } else {
                    showNotification(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        // Verification Management
        async function loadActiveVerifications() {
            try {
                const res = await fetch(`${API_BASE}/admin/verifications/active`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                const container = document.getElementById('verifications-management');
                
                if (data.verifications.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; text-align: center;">No active verifications</p>';
                } else {
                    container.innerHTML = data.verifications.map(v => `
                        <div class="verification-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${v.user_email}</strong> - ${v.service_name}
                                <div style="font-size: 14px; color: #6b7280;">
                                    Phone: ${v.phone_number} | Cost: N${v.cost}
                                </div>
                                <div style="font-size: 12px; color: #9ca3af;">
                                    ${new Date(v.created_at).toLocaleString()}
                                </div>
                            </div>
                            <button onclick="cancelVerification('${v.id}')" class="btn-danger btn-small">Cancel & Refund</button>
                        </div>
                    `).join('');
                }
            } catch (err) {
                showNotification('Failed to load verifications', 'error');
            }
        }

        async function cancelVerification(verificationId) {
            if (!confirm('Cancel this verification and refund the user?')) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/verifications/${verificationId}/cancel`, {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(data.message, 'success');
                    loadActiveVerifications();
                } else {
                    showNotification(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        // Service Pricing Management
        async function loadServicePricing() {
            try {
                const res = await fetch(`${API_BASE}/admin/pricing/services`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                const container = document.getElementById('pricing-management');
                
                container.innerHTML = `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h3 style="margin: 0 0 10px 0;">Default Pricing</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #667eea;">N${data.default_popular}</div>
                                <div style="color: #64748b; font-size: 13px; margin-top: 5px;">Popular Services</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">N${data.default_general}</div>
                                <div style="color: #64748b; font-size: 13px; margin-top: 5px;">General Services</div>
                            </div>
                        </div>
                    </div>
                    ${data.custom_pricing.length > 0 ? `
                        <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                            <h3 style="margin: 0 0 15px 0;">Custom Pricing (${data.custom_pricing.length} services)</h3>
                            ${data.custom_pricing.map(p => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px;">
                                    <div>
                                        <strong style="text-transform: capitalize;">${p.service_name}</strong>
                                        ${p.is_popular ? '<span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">POPULAR</span>' : ''}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <strong style="color: #10b981;">N${p.price}</strong>
                                        <button onclick="removeCustomPricing('${p.service_name}')" class="btn-danger btn-small">Remove</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #64748b; text-align: center;">No custom pricing set</p>'}
                `;
            } catch (err) {
                showNotification('Failed to load pricing', 'error');
            }
        }

        function showSetPricing() {
            const container = document.getElementById('pricing-management');
            container.innerHTML = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                    <h3 style="margin: 0 0 15px 0;">Set Service Price</h3>
                    <input type="text" id="price-service-name" placeholder="Service name (e.g., whatsapp)" style="width: 100%; margin-bottom: 10px;">
                    <input type="number" id="price-amount" placeholder="Price (N)" step="0.25" min="0.50" style="width: 100%; margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                        <input type="checkbox" id="price-is-popular">
                        <span>Mark as popular service</span>
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="setServicePrice()">Set Price</button>
                        <button onclick="loadServicePricing()" class="btn-danger">Cancel</button>
                    </div>
                </div>
            `;
        }

        async function setServicePrice() {
            const serviceName = document.getElementById('price-service-name').value.toLowerCase().trim();
            const price = parseFloat(document.getElementById('price-amount').value);
            const isPopular = document.getElementById('price-is-popular').checked;
            
            if (!serviceName || !price || price < 0.5) {
                return showNotification('Invalid input', 'error');
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/pricing/services/${serviceName}?price=${price}&is_popular=${isPopular}`, {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(data.message, 'success');
                    loadServicePricing();
                } else {
                    showNotification(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        async function removeCustomPricing(serviceName) {
            if (!confirm(`Remove custom pricing for ${serviceName}?`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/pricing/services/${serviceName}`, {
                    method: 'DELETE',
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(data.message, 'success');
                    loadServicePricing();
                } else {
                    showNotification(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        function showBulkPricing() {
            const container = document.getElementById('pricing-management');
            container.innerHTML = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                    <h3 style="margin: 0 0 10px 0;">Bulk Update Pricing</h3>
                    <p style="color: #64748b; margin-bottom: 15px; font-size: 14px;">Enter one service per line in format: service_name=price</p>
                    <textarea id="bulk-pricing-input" rows="10" placeholder="whatsapp=1.00\ntelegram=1.00\ninstagram=1.25" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: monospace; margin-bottom: 15px;"></textarea>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="bulkUpdatePricing()">Update All</button>
                        <button onclick="loadServicePricing()" class="btn-danger">Cancel</button>
                    </div>
                </div>
            `;
        }

        async function bulkUpdatePricing() {
            const input = document.getElementById('bulk-pricing-input').value;
            const lines = input.split('\n').filter(l => l.trim());
            
            const services = {};
            for (const line of lines) {
                const [service, price] = line.split('=').map(s => s.trim());
                if (service && price) {
                    services[service.toLowerCase()] = parseFloat(price);
                }
            }
            
            if (Object.keys(services).length === 0) {
                return showNotification('No valid entries', 'error');
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/pricing/bulk`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(services)
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(data.message, 'success');
                    loadServicePricing();
                } else {
                    showNotification(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        // Rental Management
        async function loadActiveRentals() {
            try {
                const res = await fetch(`${API_BASE}/admin/rentals/active`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                const container = document.getElementById('rentals-management');
                
                if (data.rentals.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; text-align: center;">No active rentals</p>';
                } else {
                    container.innerHTML = data.rentals.map(r => `
                        <div class="verification-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${r.user_email}</strong> - ${r.service_name}
                                <div style="font-size: 14px; color: #6b7280;">
                                    Phone: ${r.phone_number} | Cost: N${r.cost}
                                </div>
                                <div style="font-size: 12px; color: #9ca3af;">
                                    Expires: ${new Date(r.expires_at).toLocaleString()}
                                </div>
                            </div>
                            <button onclick="forceReleaseRental('${r.id}')" class="btn-danger btn-small">Force Release</button>
                        </div>
                    `).join('');
                }
            } catch (err) {
                showNotification('Failed to load rentals', 'error');
            }
        }

        async function forceReleaseRental(rentalId) {
            if (!confirm('Force release this rental?')) return;
            
            try {
                const res = await fetch(`${API_BASE}/admin/rentals/${rentalId}/release`, {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(data.message, 'success');
                    loadActiveRentals();
                } else {
                    showNotification(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        // System Configuration
        async function loadSystemConfig() {
            try {
                const res = await fetch(`${API_BASE}/admin/config`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                const container = document.getElementById('system-config');
                
                const configs = Object.entries(data.config);
                if (configs.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; text-align: center;">No configuration set</p>';
                } else {
                    container.innerHTML = configs.map(([key, val]) => `
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong style="color: #667eea;">${key}</strong>
                                    <div style="font-size: 14px; color: #6b7280; margin-top: 5px;">${val.value}</div>
                                    ${val.description ? `<div style="font-size: 12px; color: #9ca3af; margin-top: 3px;">${val.description}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                showNotification('Failed to load config', 'error');
            }
        }

        function showSetConfig() {
            const container = document.getElementById('system-config');
            container.innerHTML = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                    <h3 style="margin: 0 0 15px 0;">Set Configuration</h3>
                    <input type="text" id="config-key" placeholder="Configuration key" style="width: 100%; margin-bottom: 10px;">
                    <input type="text" id="config-value" placeholder="Value" style="width: 100%; margin-bottom: 10px;">
                    <textarea id="config-description" rows="3" placeholder="Description (optional)" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 15px;"></textarea>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="setSystemConfig()">Set Config</button>
                        <button onclick="loadSystemConfig()" class="btn-danger">Cancel</button>
                    </div>
                </div>
            `;
        }

        async function setSystemConfig() {
            const key = document.getElementById('config-key').value.trim();
            const value = document.getElementById('config-value').value.trim();
            const description = document.getElementById('config-description').value.trim();
            
            if (!key || !value) {
                return showNotification('Key and value required', 'error');
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/config/${key}?value=${encodeURIComponent(value)}&description=${encodeURIComponent(description)}`, {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await res.json();
                if (res.ok) {
                    showNotification(data.message, 'success');
                    loadSystemConfig();
                } else {
                    showNotification(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }
    </script>
</body>
</html>
