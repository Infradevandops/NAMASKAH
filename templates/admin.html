<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Namaskah SMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/track.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>🔧 Admin Panel</h1>
            <p>Manage Users & Credits</p>
        </header>

        <div id="auth-section">
            <div class="card">
                <h2>Admin Login</h2>
                <input type="email" id="admin-email" placeholder="Admin Email" required>
                <input type="password" id="admin-password" placeholder="Password" required>
                <button onclick="adminLogin()">Login</button>
            </div>
        </div>

        <div id="admin-section" class="hidden">
            <div class="user-info">
                <span id="admin-email-display"></span>
                <button onclick="logout()">Logout</button>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">📊 Statistics</h2>
                    <select id="period-select" onchange="loadStats()" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; background: white;">
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="60">Last 60 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div id="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 28px; font-weight: bold;" id="total-users">0</div>
                        <div style="opacity: 0.9;">Total Users</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 28px; font-weight: bold;" id="new-users">0</div>
                        <div style="opacity: 0.9;">New Users</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 28px; font-weight: bold;" id="total-verifications">0</div>
                        <div style="opacity: 0.9;">Verifications</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 8px;">
                        <div style="font-size: 28px; font-weight: bold;" id="total-revenue">$0</div>
                        <div style="opacity: 0.9;">Revenue</div>
                    </div>
                </div>
                
                <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <h3 style="margin: 0 0 15px 0;">🔥 Most Used Services</h3>
                    <div id="popular-services"></div>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">👥 Users</h2>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="user-search" placeholder="Search users..." style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px;" oninput="searchUsers()">
                        <button onclick="loadUsers()" class="btn-small">Refresh</button>
                        <button onclick="exportUsers()" class="btn-small" style="background: #10b981;">📄 Export CSV</button>
                    </div>
                </div>
                <div id="users-list"></div>
                <div id="pagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;"></div>
            </div>

            <div class="card">
                <h2>🎫 Support Tickets</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="loadTickets('open')" class="btn-small">Open</button>
                    <button onclick="loadTickets('resolved')" class="btn-small">Resolved</button>
                    <button onclick="loadTickets()" class="btn-small">All</button>
                </div>
                <div id="tickets-list"></div>
            </div>

            <div id="ticket-modal" class="card hidden">
                <h2>Respond to Ticket</h2>
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div><strong>From:</strong> <span id="ticket-email"></span></div>
                    <div><strong>Category:</strong> <span id="ticket-category"></span></div>
                    <div style="margin-top: 10px;"><strong>Message:</strong></div>
                    <div id="ticket-message" style="margin-top: 5px; color: #6b7280;"></div>
                </div>
                <textarea id="ticket-response" rows="5" placeholder="Your response..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="respondToTicket()">Send Response</button>
                    <button onclick="closeTicketModal()" class="btn-danger">Cancel</button>
                </div>
            </div>

            <div id="add-credits-modal" class="card hidden">
                <h2>Add Credits</h2>
                <p><strong>User:</strong> <span id="selected-user-email"></span></p>
                <input type="number" id="credits-amount" placeholder="Amount" step="0.50" min="0.50">
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button onclick="addCredits()">Add Credits</button>
                    <button onclick="closeModal()" class="btn-danger">Cancel</button>
                </div>
            </div>
        </div>

        <div id="notification" class="notification hidden"></div>
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let token = localStorage.getItem('admin_token');
        let selectedUserId = null;

        if (token) {
            checkAuth();
        }

        async function adminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                
                const data = await res.json();
                
                if (res.ok && data.is_admin) {
                    token = data.token;
                    localStorage.setItem('admin_token', token);
                    showNotification('Admin login successful!', 'success');
                    showAdmin();
                } else if (res.ok && !data.is_admin) {
                    showNotification('Not an admin account', 'error');
                } else {
                    showNotification(data.detail || 'Login failed', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE}/auth/me`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                
                if (res.ok) {
                    const user = await res.json();
                    if (user.is_admin) {
                        document.getElementById('admin-email-display').textContent = user.email;
                        showAdmin();
                    } else {
                        logout();
                    }
                } else {
                    logout();
                }
            } catch (err) {
                logout();
            }
        }

        function showAdmin() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('admin-section').classList.remove('hidden');
            loadStats();
            loadUsers();
            loadTickets();
        }

        function logout() {
            token = null;
            localStorage.removeItem('admin_token');
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('admin-section').classList.add('hidden');
        }

        async function loadStats() {
            try {
                const period = document.getElementById('period-select').value;
                const res = await fetch(`${API_BASE}/admin/stats?period=${period}`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('total-users').textContent = data.total_users;
                    document.getElementById('new-users').textContent = data.new_users || 0;
                    document.getElementById('total-verifications').textContent = data.total_verifications;
                    document.getElementById('total-revenue').textContent = `$${data.total_revenue.toFixed(2)}`;
                    
                    // Popular services
                    const servicesList = document.getElementById('popular-services');
                    if (data.popular_services && data.popular_services.length > 0) {
                        servicesList.innerHTML = data.popular_services.map((s, i) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 6px; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">${['🥇', '🥈', '🥉', '4️⃣', '5️⃣', '6️⃣', '7️⃣', '8️⃣', '9️⃣', '🔟'][i] || '📱'}</span>
                                    <strong style="text-transform: capitalize;">${s.service}</strong>
                                </div>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 600;">${s.count} uses</span>
                                    <span style="color: #10b981; font-weight: 600;">$${s.revenue.toFixed(2)}</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        servicesList.innerHTML = '<p style="color: #6b7280; text-align: center;">No data available</p>';
                    }
                }
            } catch (err) {
                showNotification('Failed to load stats', 'error');
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_BASE}/admin/users`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                
                if (res.ok) {
                    const data = await res.json();
                    allUsers = data.users;
                    renderUsers(allUsers);
                    /*
                    const list = document.getElementById('users-list');
                    list.innerHTML = data.users.map(u => `
                        <div class="verification-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${u.email}</strong>
                                <div style="font-size: 14px; color: #6b7280;">
                                    Credits: $${u.credits.toFixed(2)} ${u.is_admin ? '| Admin' : ''}
                                </div>
                                <div style="font-size: 12px; color: #9ca3af;">
                                    Joined: ${new Date(u.created_at).toLocaleDateString()}
                                </div>
                            </div>
                            <button onclick="openAddCredits('${u.id}', '${u.email}')" class="btn-small">
                                Add Credits
                            </button>
                        </div>
                    `).join('');*/
                    
                    showNotification('Users loaded', 'success');
                }
            } catch (err) {
                showNotification('Failed to load users', 'error');
            }
        }

        function openAddCredits(userId, email) {
            selectedUserId = userId;
            document.getElementById('selected-user-email').textContent = email;
            document.getElementById('add-credits-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('add-credits-modal').classList.add('hidden');
            selectedUserId = null;
        }

        async function addCredits() {
            const amount = parseFloat(document.getElementById('credits-amount').value);
            
            if (!amount || amount <= 0) {
                showNotification('Invalid amount', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/admin/credits/add`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({user_id: selectedUserId, amount})
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showNotification(data.message, 'success');
                    closeModal();
                    loadUsers();
                    loadStats();
                } else {
                    showNotification('Failed to add credits', 'error');
                }
            } catch (err) {
                showNotification('Network error', 'error');
            }
        }

        let allUsers = [];
        let currentTicketId = null;

        function searchUsers() {
            const query = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                u.email.toLowerCase().includes(query) || u.id.includes(query)
            );
            renderUsers(filtered);
        }

        function renderUsers(users) {
            const list = document.getElementById('users-list');
            list.innerHTML = users.map(u => `
                <div class="verification-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${u.email}</strong>
                        <div style="font-size: 14px; color: #6b7280;">
                            Credits: $${u.credits.toFixed(2)} | Free: ${u.free_verifications || 0} ${u.is_admin ? '| 👑 Admin' : ''}
                        </div>
                        <div style="font-size: 12px; color: #9ca3af;">
                            Joined: ${new Date(u.created_at).toLocaleDateString()}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="viewUserDetails('${u.id}')" class="btn-small">View</button>
                        <button onclick="openAddCredits('${u.id}', '${u.email}')" class="btn-small">Add Credits</button>
                    </div>
                </div>
            `).join('');
        }

        async function viewUserDetails(userId) {
            try {
                const res = await fetch(`${API_BASE}/admin/users/${userId}`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                if (res.ok) {
                    const data = await res.json();
                    alert(`User: ${data.user.email}\nCredits: $${data.user.credits}\nTotal Verifications: ${data.stats.total_verifications}\nTotal Spent: $${data.stats.total_spent}`);
                }
            } catch (err) {
                showNotification('Failed to load user details', 'error');
            }
        }

        async function exportUsers() {
            try {
                const response = await fetch(`${API_BASE}/admin/export/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    showNotification('Export failed: Not authenticated', 'error');
                    return;
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showNotification('Users exported successfully!', 'success');
            } catch (error) {
                showNotification('Failed to export users', 'error');
            }
        }

        async function loadTickets(status = null) {
            try {
                const url = status ? `${API_BASE}/admin/support/tickets?status=${status}` : `${API_BASE}/admin/support/tickets`;
                const res = await fetch(url, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                if (res.ok) {
                    const data = await res.json();
                    const list = document.getElementById('tickets-list');
                    if (data.tickets.length === 0) {
                        list.innerHTML = '<p style="color: #6b7280; text-align: center;">No tickets found</p>';
                    } else {
                        list.innerHTML = data.tickets.map(t => `
                            <div class="verification-item" style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${t.name}</strong> (${t.email})
                                    <div style="font-size: 14px; color: #6b7280;">
                                        ${t.category} | ${t.status}
                                    </div>
                                    <div style="font-size: 12px; color: #9ca3af;">
                                        ${new Date(t.created_at).toLocaleString()}
                                    </div>
                                </div>
                                <button onclick="openTicketModal('${t.id}', '${t.name}', '${t.email}', '${t.category}', '${t.message.replace(/'/g, "\\'")}')">Respond</button>
                            </div>
                        `).join('');
                    }
                }
            } catch (err) {
                showNotification('Failed to load tickets', 'error');
            }
        }

        function openTicketModal(id, name, email, category, message) {
            currentTicketId = id;
            document.getElementById('ticket-email').textContent = `${name} (${email})`;
            document.getElementById('ticket-category').textContent = category;
            document.getElementById('ticket-message').textContent = message;
            document.getElementById('ticket-modal').classList.remove('hidden');
        }

        function closeTicketModal() {
            document.getElementById('ticket-modal').classList.add('hidden');
            currentTicketId = null;
        }

        async function respondToTicket() {
            const response = document.getElementById('ticket-response').value;
            if (!response) {
                showNotification('Please enter a response', 'error');
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/admin/support/${currentTicketId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({response})
                });
                if (res.ok) {
                    showNotification('Response sent!', 'success');
                    closeTicketModal();
                    loadTickets();
                }
            } catch (err) {
                showNotification('Failed to send response', 'error');
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
